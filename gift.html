<!-- A Gift for You - v13.1 - 2025-12-12 10:00 PM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <title>A Gift for You</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        body {
            touch-action: none;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #000;
        }
        /* Hide scrollbar for settings panel */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Slider Styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%; background: #8ec5fc;
            cursor: pointer; margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: #e2e8f0; border-radius: 2px;
        }
        
        /* Modal Animation Classes */
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.invisible { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .scale-in { transform: scale(1); }
        .scale-out { transform: scale(0.95); }

        /* Code Block Styling */
        pre { white-space: pre-wrap; word-wrap: break-word; }
        
        /* Added for v13 Text Injection support */
        #custom-message-container { pointer-events: auto; }
        #custom-message-container a { color: #8ec5fc; text-decoration: underline; }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen font-sans text-slate-800">

    <canvas class="block absolute top-0 left-0 w-full h-full z-0" id="gameCanvas"></canvas>

    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10 transition-opacity duration-1000 opacity-100 text-white/90 text-center drop-shadow-md" id="overlay">
        <h1 class="text-3xl md:text-5xl font-light mb-4 tracking-widest" id="main-title">A Gift for You</h1>
        <div id="main-subtitle-container">
            <p class="text-lg md:text-xl font-light leading-relaxed">
                Tap to Bloom<br>
                Double Tap for Hearts<br>
                <span class="text-sm opacity-70 mt-2 block">Drag to Strum</span>
            </p>
        </div>
        <div id="custom-message-container" class="mt-4 hidden bg-black/30 p-4 rounded-lg backdrop-blur-sm max-w-lg text-sm text-left"></div>
    </div>

    <div class="fixed top-5 left-5 flex items-center gap-2 bg-black/40 backdrop-blur px-3 py-2 rounded-full text-white text-xs font-bold tracking-wide opacity-0 transition-opacity z-50 pointer-events-none" id="rec-indicator">
        <div class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
        REC
    </div>

    <div class="fixed bottom-3 inset-x-0 text-center text-[10px] text-white/60 pointer-events-none z-10 tracking-wider" id="master-footer">
      â€¢ A Gift for You â€¢ Penang 2026 â€¢ <span id="clock">--:--</span>
    </div>

    <button class="fixed top-5 right-5 w-12 h-12 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-white/30 active:scale-95 transition-all shadow-lg z-50" id="settings-trigger">
        <span class="material-symbols-outlined">settings</span>
    </button>

    <aside class="fixed top-0 right-0 w-80 h-full bg-white/95 backdrop-blur-xl shadow-2xl transform transition-transform duration-300 translate-x-full z-50 flex flex-col no-scrollbar overflow-y-auto" id="settings-panel">
        
        <div class="p-6 flex justify-between items-center border-b border-gray-100">
            <h2 class="text-lg font-bold text-gray-700 tracking-wide uppercase">Settings</h2>
            <button class="text-gray-400 hover:text-gray-700 transition-colors" id="close-btn">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>

        <div class="p-6 space-y-8 flex-1">
            
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Sound</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="audio-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-300"></div>
                </label>
            </div>

            <div class="space-y-3">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Background</span>
                <div class="space-y-2">
                    <input class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="bg-upload-input" type="file" accept="image/*">
                    <div class="grid grid-cols-2 gap-2">
                        <button class="w-full py-2 bg-blue-100 text-blue-700 text-xs font-semibold rounded hover:bg-blue-200 transition" id="apply-bg-btn">
                            Apply Image
                        </button>
                        <button class="w-full py-2 bg-gray-100 text-gray-500 text-xs font-medium rounded hover:bg-gray-200 transition" id="reset-bg-btn">
                            Reset Gradient
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Custom Words</span>
                <textarea class="w-full p-3 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg focus:ring-blue-300 focus:border-blue-300 resize-none h-24" id="custom-words" placeholder="e.g. You, Peace, Kindness..."></textarea>
            </div>

            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Collab Room</span>
                    <span class="text-[10px] text-gray-400">Share code with a friend</span>
                </div>
                <div class="flex gap-2">
                    <input id="collab-room" class="flex-1 p-2 text-sm border border-gray-200 rounded-lg focus:ring-blue-300 focus:border-blue-300" placeholder="e.g. you-garden">
                    <button id="collab-connect" class="px-3 py-2 bg-emerald-50 text-emerald-700 rounded-lg text-xs font-bold border border-emerald-200 hover:bg-emerald-100 transition">Connect</button>
                </div>
                <p id="collab-role-indicator" class="text-[11px] text-gray-500 leading-snug">Role: Solo (not connected)</p>
                <div class="mt-2 p-3 bg-slate-50 border border-slate-200 rounded-lg text-[11px] text-slate-600 space-y-2" id="collab-peers">
                    <p class="font-semibold text-slate-700 text-xs">Room Participants</p>
                    <p class="text-slate-400">Not connected</p>
                </div>
                <div class="mt-3 p-3 bg-slate-50 border border-slate-200 rounded-lg text-[11px] text-slate-600 space-y-2">
                    <div class="flex items-center justify-between">
                        <p class="font-semibold text-slate-700 text-xs">Session Log</p>
                        <span id="pipeline-status" class="text-[10px] px-2 py-1 rounded-full bg-slate-200 text-slate-600">Idle</span>
                    </div>
                    <div id="session-log-feed" class="max-h-28 overflow-y-auto space-y-1 text-[10px] leading-snug">
                        <p class="text-slate-400">No activity yet.</p>
                    </div>
                </div>
                <p class="text-[11px] text-gray-500 leading-snug">When connected, taps and drags are shared live via a lightweight relay.</p>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Fade Duration (Flowers)</span>
                    </div>
                    <input type="range" id="decay-slider" min="0" max="5" step="1" value="2" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Trail Duration & Speed</span>
                    </div>
                    <input type="range" id="trail-slider" min="1" max="10" step="1" value="5" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>Short/Fast</span>
                        <span>Long/Slow</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Growth Speed</span>
                    </div>
                    <input type="range" id="speed-slider" min="1" max="100" value="50" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 pt-4 border-t border-gray-100">
                <button class="col-span-1 px-4 py-3 bg-orange-50 text-orange-700 text-sm font-semibold rounded-xl hover:bg-orange-100 transition text-center" id="record-btn">Record</button>
                <button class="col-span-1 px-4 py-3 bg-green-50 text-green-700 text-sm font-semibold rounded-xl hover:bg-green-100 transition text-center" id="save-btn">Snapshot</button>
                <button class="col-span-1 px-4 py-3 bg-gray-50 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-100 transition text-center" id="theme-btn">Theme</button>
                <button class="col-span-1 px-4 py-3 bg-indigo-50 text-indigo-700 text-sm font-semibold rounded-xl hover:bg-indigo-100 transition text-center" id="autoplay-btn">Auto-Play</button>
                <button class="col-span-1 px-4 py-3 bg-red-50 text-red-700 text-sm font-medium rounded-xl hover:bg-red-100 transition text-center" id="clear-btn">Clear</button>
                
                <button class="col-span-2 mt-2 py-4 bg-amber-50 text-amber-700 font-bold rounded-xl hover:bg-amber-100 transition text-center flex items-center justify-center gap-2 border border-amber-200 shadow-sm" id="secrets-btn">
                    <span class="material-symbols-outlined">key</span> Open Secrets
                </button>

                 <button class="col-span-1 mt-2 py-3 bg-blue-50 text-blue-700 text-sm font-bold rounded-xl hover:bg-blue-100 transition text-center flex items-center justify-center gap-2 border border-blue-200" id="info-btn">
                    <span class="material-symbols-outlined text-sm">code</span> Code
                </button>
                <button class="col-span-1 mt-2 py-3 bg-purple-50 text-purple-700 text-sm font-bold rounded-xl hover:bg-purple-100 transition text-center flex items-center justify-center gap-2 border border-purple-200" id="req-btn">
                    <span class="material-symbols-outlined text-sm">list</span> Reqs
                </button>
            </div>
        </div>
    </aside>

    <div id="secrets-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div id="secrets-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6 transform scale-out modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-amber-500">auto_awesome</span> 
                    Discoveries
                </h3>
                <button id="close-secrets" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div id="secrets-grid-view">
                <p class="text-sm text-gray-500 mb-4">
                    Unlock patterns by experimenting with rhythms (Taps) and flow (Drags). Click a discovery to see its activation code.
                </p>
                <div id="secrets-list" class="grid grid-cols-5 gap-2 max-h-60 overflow-y-auto p-1">
                    </div>
                <div class="text-center text-xs text-gray-400 mt-4">
                    Found: <span id="secrets-count">0</span> / 20
                </div>
            </div>

            <div id="secrets-detail-view" class="hidden flex flex-col">
                <button id="back-to-grid" class="text-xs text-blue-500 mb-2 flex items-center hover:underline self-start">
                    <span class="material-symbols-outlined text-sm mr-1">arrow_back</span> Back
                </button>
                
                <div class="bg-amber-50 rounded-xl p-5 border border-amber-100 text-center space-y-4">
                    <div id="detail-id" class="w-16 h-16 bg-amber-200 rounded-full flex items-center justify-center mx-auto text-amber-800 font-bold text-2xl shadow-inner">?</div>
                    
                    <div>
                        <h4 id="detail-title" class="text-lg font-bold text-amber-900">Secret Unlocked</h4>
                        <p id="detail-type" class="text-xs text-amber-700/70 uppercase tracking-wide font-bold mt-1">RHYTHM</p>
                    </div>

                    <div class="text-left bg-white/60 p-4 rounded-lg text-sm border border-amber-100 shadow-sm">
                        <p class="mb-2"><span class="font-bold text-gray-600 block text-xs uppercase mb-1">Trigger:</span>
                        <span id="detail-trigger" class="font-mono text-lg text-amber-600 tracking-wider bg-amber-50 px-2 py-1 rounded">Tap Tap</span></p>
                        
                        <p><span class="font-bold text-gray-600 block text-xs uppercase mb-1">Visual Effect:</span>
                        <span id="detail-reward" class="italic text-gray-700">Blooming Mandala</span></p>
                    </div>

                    <button id="simulate-btn" class="w-full py-3 bg-gradient-to-r from-amber-400 to-amber-500 text-white rounded-xl font-bold shadow-lg hover:from-amber-500 hover:to-amber-600 active:scale-95 transition flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">play_circle</span> Play Example
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="code-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-4xl h-[80vh] p-6 transform scale-out modal-content flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2 shrink-0">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">code</span> Source Code
                </h3>
                <button id="close-code" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="flex-1 overflow-auto bg-gray-50 p-4 rounded border border-gray-200 font-mono text-xs">
                <pre id="source-code-display">Loading...</pre>
            </div>
            <div class="mt-4 flex justify-end shrink-0">
                <button id="copy-code-btn" class="px-4 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 transition flex items-center gap-2">
                    <span class="material-symbols-outlined text-sm">content_copy</span> Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <div id="req-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-lg p-6 transform scale-out modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-500">checklist</span> Changes & Requirements
                </h3>
                <button id="close-req" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="overflow-y-auto max-h-[60vh] space-y-3 text-sm text-gray-700">
                <p class="font-bold text-gray-900">v13.1 Changelog (Sync & Fidelity):</p>
                <ul class="list-decimal pl-5 space-y-1">
                    <li><strong>Recording Sync:</strong> Background audio now routed via Web Audio API for perfect visual sync.</li>
                    <li><strong>High Fidelity:</strong> Canvas now renders at native Device Pixel Ratio (Retina/4K support).</li>
                    <li><strong>Telemetry:</strong> Added LA Timezone conversion (c19) to payload.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="autoplay-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-2xl p-6 transform scale-out modal-content flex flex-col gap-4">
            <div class="flex justify-between items-center mb-2 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-indigo-500">autoplay</span> Auto-Play Studio
                </h3>
                <button id="close-autoplay" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <p class="text-sm text-gray-600">Dial in hands-free play, save your presets locally, and load them by prefix without touching JSON.</p>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 uppercase"><span>Events per Minute</span><span id="auto-rate-label">60</span></div>
                        <input type="range" id="auto-rate" min="10" max="200" value="60" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 uppercase"><span>Randomness</span><span id="auto-random-label">40%</span></div>
                        <input type="range" id="auto-random" min="0" max="100" value="40" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 uppercase"><span>Chord Chance</span><span id="auto-chord-label">20%</span></div>
                        <input type="range" id="auto-chord" min="0" max="100" value="20" class="w-full">
                    </div>
                    <label class="flex items-center gap-2 text-sm text-gray-700">
                        <input id="auto-drags" type="checkbox" class="rounded border-gray-300 text-indigo-600"> Include drags (sparingly)
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-700">
                        <input id="auto-soundscape" type="checkbox" class="rounded border-gray-300 text-indigo-600"> Favor melodic sequences
                    </label>
                </div>
                <div class="space-y-3">
                    <div class="flex items-center gap-2 text-sm">
                        <label class="text-xs font-bold text-gray-500 uppercase">Preset</label>
                        <select id="auto-preset" class="flex-1 border border-gray-200 rounded px-2 py-1 text-sm">
                            <option value="calm">Calm Drift</option>
                            <option value="balanced">Balanced</option>
                            <option value="intense">Bloom Storm</option>
                        </select>
                        <button id="auto-save-preset" class="px-3 py-2 bg-indigo-50 text-indigo-700 rounded text-xs font-bold border border-indigo-200 hover:bg-indigo-100">Save</button>
                    </div>
                    <div class="flex gap-2">
                        <button id="auto-toggle" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined text-sm" id="auto-toggle-icon">play_arrow</span>
                            <span id="auto-toggle-label">Start</span>
                        </button>
                    </div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2 text-xs text-gray-700">
                        <div class="flex items-center gap-2">
                            <label class="font-bold text-gray-600 text-[11px] uppercase">Prefix</label>
                            <input id="auto-file-prefix" class="flex-1 border border-gray-200 rounded px-2 py-1 text-xs" value="you-" placeholder="prefix-">
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="auto-file-name" class="flex-1 border border-gray-200 rounded px-2 py-1 text-xs" placeholder="gentle-drift">
                            <button id="auto-save-file" class="px-3 py-2 bg-white border border-gray-200 rounded font-semibold hover:bg-gray-100 text-[11px]">Save</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <select id="auto-file-chooser" class="flex-1 border border-gray-200 rounded px-2 py-2 text-xs bg-white"></select>
                            <button id="auto-load-file" class="px-3 py-2 bg-indigo-50 text-indigo-700 rounded font-bold border border-indigo-200 hover:bg-indigo-100 text-[11px]">Load</button>
                        </div>
                        <p class="text-[11px] text-gray-500">Saved files are filtered by prefix above and sorted automatically.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="auto-run-icon" class="fixed bottom-20 right-5 w-12 h-12 bg-indigo-500/80 text-white rounded-full shadow-xl flex items-center justify-center z-40 backdrop-blur hover:scale-105 active:scale-95 transition-all border border-white/30">
        <span class="material-symbols-outlined">autoplay</span>
    </button>

    <script>
        /**
         * A Gift for You - Penang 2026 (Baseline + Injection)
         */

        // --- 1. Core Config & State ---
        const GOOGLE_SHEET_SPLASH_CSV = "https://docs.google.com/spreadsheets/d/1lSxTIZbtXWdxCUWqdqan-hCV1f5_aWQCoV-HXSRHxng/edit?usp=drivesdk";
        const config = {
            currentThemeIndex: 0,
            defaultWords: [
                "Peace", "Gentle", "Warmth", "Love", "Hope", "Empathy", "Calm", "Grace", "Kindness", "Light", "Joy", "Bliss",
                "Serenity", "Breathe Deep", "Be Here", "Soften", "Let Go", "â¤ï¸â¤ï¸â¤ï¸", "ðŸª·ðŸª·ðŸª·", "Balance", "Harmony",
                "Inner Peace", "Radiate", "Stillness", "Presence", "Gratitude", "Acceptance", "Flow", "Healing", "Strength",
                "Wisdom", "Patience", "Courage", "Hi You  :)", "Clarity", "Unity", "Wholeness","Youà¸›à¸£à¸°à¸ªà¸šà¸„à¸§à¸²à¸¡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ","à¸„à¸§à¸²à¸¡à¸ªà¸¸à¸‚à¸¢à¹ˆà¸­à¸¡à¸„à¸¹à¹ˆà¸„à¸§à¸£à¸à¸±à¸šà¸„à¸§à¸²à¸¡à¸ªà¸‡à¸šà¸ªà¸¸à¸‚à¹à¸¥à¸°à¸„à¸§à¸²à¸¡à¹€à¸ˆà¸£à¸´à¸à¸£à¸¸à¹ˆà¸‡à¹€à¸£à¸·à¸­à¸‡","â¤ï¸â¤ï¸â¤ï¸","You ðŸª·à¹€à¸à¸µà¹ˆà¸¢à¸§à¸”à¸­à¸‡à¸à¸±à¸™","You ðŸµï¸ ","à¸­à¸²à¸—à¸£ ðŸŒ¼","à¸­à¸²à¸—à¸£","à¸ˆà¸´à¸•à¸§à¸´à¸à¸à¸²à¸“à¸—à¸µà¹ˆà¸‡à¸”à¸‡à¸²à¸¡"
            ],
            customWords: [],
            speedMultiplier: 1.0,
            decayValue: 0.005,
            trailDecay: 0.01,
            trailSpeed: 1.0,
            useGradient: true,
            backgroundImage: null,
            // Trail State
            currentTrail: 'â™¥',
            lastTrailSwitch: Date.now()
        };

        const themes = [
            { bg: ['#e0c3fc', '#8ec5fc'], text: '#4a148c' },
            { bg: ['#fad0c4', '#ffd1ff'], text: '#880e4f' },
            { bg: ['#d299c2', '#fef9d7'], text: '#3e2723' },
            { bg: ['#a1c4fd', '#c2e9fb'], text: '#01579b' },
            { bg: ['#d4fc79', '#96e6a1'], text: '#1b5e20' }
        ];

        const secretWords = [
            "I Love You", "You are my Sunshine", "I Love You My Sweetheart", "â¤ï¸â¤ï¸â¤ï¸", "ðŸ¥°â¤ï¸â™¥ï¸ðŸ§¡ðŸ«°","whereever you go that's where I want to be", "Forever Yours", "My One and Only", "Soulmate", "Endless Love","My Heart is Yours", "Together Always", "You Complete Me", "My Happy Place", "Love of My Life", "Dream Come True","My Everything", "Cherished", "Adored", "My Rock", "Purest Love", "Only You", "Sweetheart", "Darling",
            "Beloved", "My Angel", "Home is You", "Infinite Love", "Unconditional", "My Better Half", "Twin Flame"
        ];
        
        const sessionLog = [];
        const SESSION_LOG_LIMIT = 200;
        const sessionLogFeed = document.getElementById('session-log-feed');
        const pipelineStatusEl = document.getElementById('pipeline-status');
        const collabPeersEl = document.getElementById('collab-peers');
        const collabPeers = {};
        let pipelineSendCount = 0;

        const COLLAB_MANIFEST_CSV = ""; // Optional: published CSV with columns room, master, ts
        const COLLAB_MANIFEST_FORM_URL = ""; // Optional: Google Form URL for manifest writes
        const COLLAB_MANIFEST_FORM_FIELDS = { room: "entry.room", master: "entry.master", ts: "entry.ts", status: "entry.status" };
        const MASTER_NEGOTIATION_MS = 2600;
        const MASTER_LEASE_MS = 45000;
        const MASTER_STALE_GRACE_MS = 8000;

        function fmtTime(ts) {
            return new Date(ts).toLocaleTimeString([], { hour12: false });
        }

        function setPipelineStatus(label, tone = 'muted') {
            if (!pipelineStatusEl) return;
            pipelineStatusEl.textContent = label;
            pipelineStatusEl.className = 'text-[10px] px-2 py-1 rounded-full';
            if (tone === 'success') pipelineStatusEl.classList.add('bg-emerald-100','text-emerald-700','border','border-emerald-200');
            else if (tone === 'warn') pipelineStatusEl.classList.add('bg-amber-100','text-amber-700','border','border-amber-200');
            else if (tone === 'error') pipelineStatusEl.classList.add('bg-red-100','text-red-700','border','border-red-200');
            else pipelineStatusEl.classList.add('bg-slate-200','text-slate-600');
        }

        function appendSessionLog(type, detail, options = {}) {
            if (options.skipLog) return;
            const entry = { ts: Date.now(), type, detail: (detail ?? '').toString() };
            sessionLog.push(entry);
            if (sessionLog.length > SESSION_LOG_LIMIT) sessionLog.shift();
            renderSessionLog();
        }

        function renderSessionLog() {
            if (!sessionLogFeed) return;
            sessionLogFeed.innerHTML = '';
            const recent = sessionLog.slice(-30);
            if (!recent.length) {
                const p = document.createElement('p');
                p.className = 'text-slate-400';
                p.textContent = 'No activity yet.';
                sessionLogFeed.appendChild(p);
                return;
            }
            recent.forEach(item => {
                const row = document.createElement('p');
                row.className = 'text-slate-600';
                row.textContent = `[${fmtTime(item.ts)}] ${item.type}: ${item.detail}`;
                sessionLogFeed.appendChild(row);
            });
        }

        function touchPeer(id, alias, meta = {}) {
            if (!id) return;
            const existing = collabPeers[id] || {};
            const firstSeen = existing.firstSeen || meta.firstSeen || meta.ts || Date.now();
            collabPeers[id] = {
                ...existing,
                ...meta,
                alias: alias || existing.alias || id.slice(0, 6),
                lastSeen: Date.now(),
                firstSeen
            };
            updatePeerList();
        }

        function prunePeers() {
            const now = Date.now();
            let changed = false;
            Object.entries(collabPeers).forEach(([id, peer]) => {
                if (now - peer.lastSeen > 45000 && id !== 'local') {
                    delete collabPeers[id];
                    changed = true;
                }
            });
            if (changed) updatePeerList();
        }

        function isManifestFresh(entry) {
            if (!entry || !entry.ts) return false;
            const ts = Number(entry.ts);
            if (Number.isNaN(ts)) return false;
            return Date.now() - ts < (MASTER_LEASE_MS + MASTER_STALE_GRACE_MS);
        }

        async function fetchManifestState(room) {
            if (!COLLAB_MANIFEST_CSV || !room) return null;
            try {
                const r = await fetch(COLLAB_MANIFEST_CSV, { cache: 'no-store' });
                if (!r.ok) return null;
                const csv = (await r.text()).trim();
                if (!csv) return null;
                const lines = csv.split(/\r?\n/).filter(Boolean);
                if (!lines.length) return null;
                const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());
                const idxRoom = headers.indexOf('room');
                const idxMaster = headers.indexOf('master');
                const idxTs = headers.indexOf('ts');
                const idxStatus = headers.indexOf('status');
                if (idxRoom === -1 || idxMaster === -1 || idxTs === -1) return null;
                let latest = null;
                lines.forEach(line => {
                    const parts = line.split(',');
                    const lineRoom = (parts[idxRoom] || '').trim().toLowerCase();
                    if (!lineRoom || lineRoom !== room.toLowerCase()) return;
                    const candidate = {
                        room: lineRoom,
                        master: (parts[idxMaster] || '').trim(),
                        ts: Number(parts[idxTs]),
                        status: idxStatus >= 0 ? (parts[idxStatus] || '').trim() : 'unknown'
                    };
                    if (!candidate.master || Number.isNaN(candidate.ts)) return;
                    if (!latest || candidate.ts > latest.ts) latest = candidate;
                });
                return latest;
            } catch (e) {
                console.warn('manifest fetch failed', e);
                return null;
            }
        }

        async function publishManifest(masterId, status = 'active') {
            if (!COLLAB_MANIFEST_FORM_URL) return;
            try {
                const fd = new FormData();
                const roomField = COLLAB_MANIFEST_FORM_FIELDS.room;
                const masterField = COLLAB_MANIFEST_FORM_FIELDS.master;
                const tsField = COLLAB_MANIFEST_FORM_FIELDS.ts;
                const statusField = COLLAB_MANIFEST_FORM_FIELDS.status;
                if (roomField) fd.append(roomField, collabRoomCode || 'you-garden');
                if (masterField) fd.append(masterField, masterId || '');
                if (tsField) fd.append(tsField, Date.now());
                if (statusField) fd.append(statusField, status);
                await fetch(COLLAB_MANIFEST_FORM_URL, { method: 'POST', mode: 'no-cors', body: fd, keepalive: true });
                appendSessionLog('manifest', `Manifest updated (${status}).`, { skipLog: !collabActive });
            } catch (e) {
                console.warn('manifest publish failed', e);
            }
        }

        async function refreshMasterFromManifest(reason = 'manual') {
            if (!collabActive || !collabRoomCode) return false;
            const entry = await fetchManifestState(collabRoomCode);
            if (entry && entry.master && isManifestFresh(entry)) {
                adoptMaster(entry.master, entry.ts);
                appendSessionLog('collab', `Adopted manifest master (${reason}).`, { skipLog: !collabActive });
                return true;
            }
            return false;
        }

        async function resolveMasterClaim(reason = 'timer') {
            if (collabMasterId) return;
            const adopted = await refreshMasterFromManifest(reason);
            if (!adopted && !collabMasterId) {
                claimMasterRole();
                publishManifest(collabMasterId, 'active');
            }
        }

        function updatePeerList() {
            if (!collabPeersEl) return;
            collabPeersEl.innerHTML = `<p class="font-semibold text-slate-700 text-xs">Room Participants</p>`;
            const peers = Object.entries(collabPeers).sort((a,b) => (a[1].alias || a[0]).localeCompare(b[1].alias || b[0]));
            if (!peers.length) {
                const p = document.createElement('p');
                p.className = 'text-slate-400';
                p.textContent = 'Not connected';
                collabPeersEl.appendChild(p);
                return;
            }
            peers.forEach(([id, peer]) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between text-[10px] text-slate-600';
                const badge = peer.master ? 'Master' : 'Guest';
                row.innerHTML = `<span class="font-semibold ${id==='local'?'text-emerald-700':''}">${peer.alias || id.slice(0,6)}</span><span class="px-2 py-0.5 rounded-full bg-slate-200 text-slate-600">${badge}</span>`;
                collabPeersEl.appendChild(row);
            });
        }

        renderSessionLog();
        setInterval(prunePeers, 10000);
        appendSessionLog('session-start', 'Experience loaded.');
        setPipelineStatus('Idle');

        let currentBgData = localStorage.getItem('garden_bg') || null;
        let visualEntities = [];
        let wordEntities = [];
        let particles = []; 
        let foundEggs = JSON.parse(localStorage.getItem('garden_egg_ids') || "[]");
        let inputBuffer = ""; 

        // --- 2. Audio Engine (MODIFIED: High Register + Routing) ---
        const ZenAudio = {
            ctx: null, enabled: true, masterGain: null, dest: null, bgNode: null,
            // MODIFIED: Raised lower register (E4+) without boosting upper range
            scale: [329.63, 369.99, 392.00, 440.00, 493.88, 523.25, 587.33, 659.25, 739.99, 880.00, 987.77, 1174.66, 1318.51],
            
            init: function() {
                if (!this.ctx && (window.AudioContext || window.webkitAudioContext)) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.3; // Standard Volume
                    
                    this.dest = this.ctx.createMediaStreamDestination();
                    this.masterGain.connect(this.ctx.destination);
                    this.masterGain.connect(this.dest);
                }
            },

            // Connect external HTML Audio Element to Web Audio Graph for Sync Recording
            connectBackground: function(audioEl) {
                if (!this.ctx) this.init();
                if (this.bgNode) return; // Already connected
                
                try {
                    // Create source from the <audio> element
                    this.bgNode = this.ctx.createMediaElementSource(audioEl);
                    // Connect to masterGain (which goes to speakers AND recorder)
                    this.bgNode.connect(this.masterGain);
                } catch(e) {
                    console.error("Audio routing failed (likely CORS or state):", e);
                }
            },

            // Instant Wake Up (Fixes 1st Drag Mute)
            warmUp: function() {
                if (!this.ctx) this.init();
                if (this.ctx && (this.ctx.state === 'suspended' || this.ctx.state === 'interrupted')) {
                    this.ctx.resume();
                }
                
                if (this.ctx && this.enabled) {
                    // Play imperceptible silence to force hardware engage
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    gain.gain.value = 0.001; 
                    osc.connect(gain);
                    gain.connect(this.masterGain);
                    osc.start();
                    osc.stop(this.ctx.currentTime + 0.01);
                }
            },

            getFreqIndex: function(y, height) {
                const norm = 1 - Math.max(0, Math.min(1, y / height));
                return Math.floor(norm * (this.scale.length - 1));
            },
            
            // Classic Karplus-Strong Pluck
            playPluck: function(freq, volume = 0.3) {
                if (!this.ctx || !this.enabled) return;
                if (this.ctx.state !== 'running') this.ctx.resume().catch(()=>{});

                const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 2.0, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                const delayLength = Math.floor(this.ctx.sampleRate / freq);
                let idx = 0, last = 0;
                
                // Burst
                const noise = new Float32Array(delayLength).map(() => Math.random()*2-1);
                
                for (let i = 0; i < buffer.length; i++) {
                    // 0.99 Decay for "Classic" cleaner sound (vs 0.992 metallic)
                    const sample = (noise[idx] + last) * 0.5 * 0.99; 
                    last = noise[idx]; noise[idx] = sample;
                    data[i] = sample * volume;
                    idx = (idx + 1) % delayLength;
                }
                const src = this.ctx.createBufferSource(); src.buffer = buffer; src.connect(this.masterGain); src.start();
            },
            
            // Harmonious Triad Strum (Double Tap)
            playChord: function(baseIdx) {
                if (!this.ctx || !this.enabled) return;
                // Root
                this.playPluck(this.scale[baseIdx], 0.2);
                // 3rd (approx)
                setTimeout(() => {
                    const idx2 = Math.min(this.scale.length-1, baseIdx + 2);
                    this.playPluck(this.scale[idx2], 0.15);
                }, 40);
                // 5th (approx)
                setTimeout(() => {
                    const idx3 = Math.min(this.scale.length-1, baseIdx + 4);
                    this.playPluck(this.scale[idx3], 0.15);
                }, 80);
            },
            
            playDiscovery: function() {
                if (!this.ctx || !this.enabled) return;
                [261.63, 329.63, 392.00, 523.25].forEach((f, i) => { setTimeout(() => this.playPluck(f, 0.2), i * 150); });
            }
        };

        // --- 3. Graphics & Entities ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            // HIGH FIDELITY UPDATE: Respect Device Pixel Ratio
            const dpr = window.devicePixelRatio || 1;
            width = window.innerWidth;
            height = window.innerHeight;
            
            // Set internal buffer size to native resolution
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            
            // Scale context so drawing logic remains in CSS pixels
            ctx.scale(dpr, dpr);
            
            document.getElementById('settings-panel').style.height = `${window.innerHeight}px`;
        }
        window.addEventListener('resize', resize);
        window.addEventListener('orientationchange', () => { setTimeout(resize, 100); });
        resize();

        const random = (min, max) => Math.random() * (max - min) + min;
        function getPastelColor() { 
            const hue = random(0, 360);
            return { hue: hue, str: `hsla(${hue}, 70%, 80%,` };
        }
        function getRandomWord() {
            if (config.customWords.length > 0) return config.customWords[Math.floor(Math.random() * config.customWords.length)];
            return config.defaultWords[Math.floor(Math.random() * config.defaultWords.length)];
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = random(-3, 3); this.vy = random(-5, 1);
                this.life = 1.0; this.decay = random(0.005, 0.02);
                this.color = color;
                this.gravity = 0.1;
                this.sparkleColor = `hsl(${random(0,360)}, 80%, 70%)`;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.vy += this.gravity;
                this.life -= this.decay;
            }
            draw(ctx) {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.sparkleColor;
                ctx.fillRect(this.x, this.y, 2, 2);
            }
            isDead() { return this.life <= 0; }
        }

        class Word {
            constructor(x, y, text) {
                this.x = x; this.y = y; this.text = text || getRandomWord();
                this.velocity = -0.5; this.alpha = 0; this.fadeIn = true;
                this.color = themes[config.currentThemeIndex].text; 
            }
            update() {
                this.y += this.velocity * config.speedMultiplier;
                if (this.fadeIn) { this.alpha += 0.02 * config.speedMultiplier; if (this.alpha>=1) this.fadeIn=false; } 
                else if (config.decayValue > 0) { this.alpha -= config.decayValue * config.speedMultiplier; }
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.alpha);
                ctx.font = "20px 'Segoe UI', sans-serif"; ctx.fillStyle = this.color;
                ctx.textAlign = "center"; ctx.shadowBlur = 4; ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.fillText(this.text, this.x, this.y); ctx.restore();
            }
            isDead() { return this.alpha <= 0 && !this.fadeIn; }
        }

        class Bloom {
            constructor(x, y, size=null) {
                this.x = x; this.y = y; this.size = 0; 
                this.maxSize = size || random(30, 80);
                this.colorObj = getPastelColor();
                this.colorBase = this.colorObj.str;
                this.petals = Math.floor(random(5, 9));
                this.alpha = 1; 
                this.compColor = `hsla(${(this.colorObj.hue + 180)%360}, 60%, 70%,`;
                this.rotation = random(0, Math.PI*2);
                const shapeRnd = Math.random();
                if(shapeRnd > 0.6) this.shape = 'pointed';
                else if (shapeRnd > 0.3) this.shape = 'round';
                else this.shape = 'hybrid';
            }
            update() {
                this.rotation += 0.002;
                if (this.size < this.maxSize) this.size += 0.5 * config.speedMultiplier;
                else if (config.decayValue > 0) this.alpha -= config.decayValue * config.speedMultiplier;
            }
            draw(ctx) {
                ctx.save();
                
                // Secret 2: Gold Filigree
                if(foundEggs.includes(2)) {
                    ctx.strokeStyle = `rgba(218, 165, 32, ${this.alpha * 0.6})`;
                    ctx.lineWidth = 0.5;
                    for(let i=0; i<5; i++) {
                        const angle = (i/5) * Math.PI*2 + this.rotation;
                        const len = this.size * 1.5;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.bezierCurveTo(this.x + Math.cos(angle - 0.4) * len * 0.5, this.y + Math.sin(angle - 0.4) * len * 0.5,
                            this.x + Math.cos(angle + 0.4) * len * 0.8, this.y + Math.sin(angle + 0.4) * len * 0.8,
                            this.x + Math.cos(angle) * len, this.y + Math.sin(angle) * len);
                        ctx.stroke(); 
                    }
                }

                for(let i=0; i<3; i++) {
                    ctx.fillStyle = this.colorBase + (this.alpha * 0.7 * (1 - i*0.2)) + ')';
                    ctx.beginPath();
                    for (let j = 0; j < this.petals; j++) {
                        const angle = (j / this.petals) * Math.PI * 2 + (i * 0.1) + this.rotation;
                        const petalSize = (this.size - (i*5));
                        if (petalSize <= 0) continue;
                        
                        ctx.moveTo(this.x, this.y);
                        if(this.shape === 'pointed') {
                            ctx.quadraticCurveTo(
                                this.x + Math.cos(angle - 0.3) * petalSize, 
                                this.y + Math.sin(angle - 0.3) * petalSize,
                                this.x + Math.cos(angle) * petalSize * 1.2,
                                this.y + Math.sin(angle) * petalSize * 1.2
                            );
                            ctx.quadraticCurveTo(
                                this.x + Math.cos(angle + 0.3) * petalSize,
                                this.y + Math.sin(angle + 0.3) * petalSize,
                                this.x, this.y
                            );
                        } else {
                            ctx.ellipse(this.x + Math.cos(angle)*(petalSize*0.5), this.y + Math.sin(angle)*(petalSize*0.5), petalSize*0.4, petalSize*0.2, angle, 0, Math.PI*2);
                        }
                    }
                    ctx.fill();
                }

                // Ornate Center
                const grad = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.size * 0.25);
                const centerAlpha = foundEggs.includes(1) ? 0.9 : 0.7; 
                grad.addColorStop(0, `rgba(255, 255, 255, ${centerAlpha})`); 
                grad.addColorStop(0.4, this.compColor + (this.alpha * centerAlpha) + ")"); 
                grad.addColorStop(1, this.compColor + "0)"); 
                ctx.fillStyle = grad;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 0.25, 0, Math.PI*2); ctx.fill();
                
                ctx.strokeStyle = `rgba(255,255,255,${this.alpha*0.6})`;
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size*0.1, 0, Math.PI*2); ctx.stroke();
                
                if(this.size > 20) {
                    ctx.fillStyle = `rgba(255,255,200,${this.alpha})`;
                    for(let k=0; k<6; k++) {
                        const dotA = (k/6)*Math.PI*2 + this.rotation;
                        const dotR = this.size * 0.2;
                        ctx.beginPath(); ctx.arc(this.x + Math.cos(dotA)*dotR, this.y + Math.sin(dotA)*dotR, 1.5, 0, Math.PI*2); ctx.fill();
                    }
                }

                ctx.restore();
            }
            isDead() { 
                if (this.alpha <= 0 && foundEggs.includes(5)) {
                    for(let k=0; k<15; k++) particles.push(new Particle(this.x, this.y, this.colorBase + '1)'));
                }
                return this.alpha <= 0; 
            }
        }

        class GrowingHeart {
            constructor(x, y) {
                this.x = x; this.y = y; this.size = 0; 
                this.maxSize = random(40, 90);
                this.hue = random(0, 360);
                this.alpha = 1;
            }
            update() {
                if (this.size < this.maxSize) this.size += 0.5 * config.speedMultiplier;
                else if (config.decayValue > 0) this.alpha -= config.decayValue * config.speedMultiplier;
            }
            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                const scale = this.size / 30;
                ctx.scale(scale, scale);
                ctx.globalAlpha = Math.max(0, this.alpha);

                let grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, 25);
                grad.addColorStop(0, "white"); 
                grad.addColorStop(0.3, `hsl(${this.hue}, 100%, 70%)`); 
                grad.addColorStop(1, `hsl(${this.hue}, 100%, 30%)`); 
                ctx.fillStyle = grad;

                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.bezierCurveTo(-10, -10, -20, 0, 0, 20);
                ctx.bezierCurveTo(20, 0, 10, -10, 0, 0);
                ctx.fill();
                
                ctx.strokeStyle = `rgba(255,255,255,${this.alpha*0.5})`;
                ctx.lineWidth = 1;
                ctx.stroke();

                ctx.restore();
            }
            isDead() { return this.alpha <= 0; }
        }

        class HeartBloom extends Bloom {
            draw(ctx) {
                ctx.save();
                const layerCount = foundEggs.includes(3) ? 5 : 3;
                for(let i=0; i<layerCount; i++) {
                    const scale = (this.size - (i*4)) / 20;
                    if (scale <= 0) continue;
                    const pCount = this.petals + (i%2); 
                    for (let j = 0; j < pCount; j++) {
                        ctx.save();
                        const angle = (j / pCount) * Math.PI * 2 + this.rotation + (i*0.2);
                        ctx.translate(this.x, this.y);
                        ctx.rotate(angle + Math.PI/2);
                        ctx.translate(0, -scale * 15);
                        ctx.scale(scale, scale);
                        
                        let grad = ctx.createRadialGradient(-3, -3, 1, 0, 0, 15);
                        grad.addColorStop(0, "rgba(255,255,255,0.4)");
                        grad.addColorStop(1, this.colorBase + (this.alpha * 0.8) + ')');
                        ctx.fillStyle = grad;

                        ctx.beginPath();
                        ctx.moveTo(0,0);
                        ctx.bezierCurveTo(-5, -5, -10, 0, 0, 10);
                        ctx.bezierCurveTo(10, 0, 5, -5, 0, 0);
                        ctx.fill();
                        ctx.restore();
                    }
                }
                ctx.fillStyle = this.compColor + this.alpha + ')';
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 0.1, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            }
        }

        class HeartCloud {
            constructor(x, y) {
                this.x = x; this.y = y; this.alpha = 1;
                this.hearts = [];
                const count = Math.floor(random(4, 12));
                const colors = ["#ff0000", "#ff7f00", "#ffff00", "#00ff00", "#0000ff", "#4b0082", "#9400d3", "#ff1493"];
                for(let i=0; i<count; i++) {
                    this.hearts.push({
                        ox: random(-40, 40), oy: random(-40, 40),
                        size: random(10, 25),
                        color: colors[Math.floor(Math.random()*colors.length)],
                        rot: random(-0.2, 0.2)
                    });
                }
            }
            update() {
                this.y -= 0.5 * config.speedMultiplier;
                if (config.decayValue > 0) this.alpha -= config.decayValue * config.speedMultiplier;
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.alpha);
                this.hearts.forEach(h => {
                    ctx.save();
                    ctx.translate(this.x + h.ox, this.y + h.oy);
                    ctx.rotate(h.rot);
                    const scale = h.size / 20;
                    ctx.scale(scale, scale);
                    
                    let grad = ctx.createRadialGradient(-5, -5, 2, 0, 0, 20);
                    grad.addColorStop(0, "white");
                    grad.addColorStop(0.3, h.color);
                    grad.addColorStop(1, "#330000"); // Depth
                    ctx.fillStyle = grad;
                    
                    ctx.beginPath();
                    ctx.moveTo(0,0);
                    ctx.bezierCurveTo(-10, -10, -20, 0, 0, 20);
                    ctx.bezierCurveTo(20, 0, 10, -10, 0, 0);
                    ctx.fill();
                    ctx.restore();
                });
                ctx.restore();
            }
            isDead() { return this.alpha <= 0; }
        }

        // --- TRAIL SYSTEM (Vivid & Opaque) ---
        class TrailBase {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.alpha = 1; 
                this.size = random(10, 20);
                this.type = type; 
                this.hue = random(0, 360);
                this.color = `hsl(${this.hue},100%,60%)`; 
                this.cometColor = `hsl(${random(200,260)},100%,80%)`;
            }
            update() {
                this.y -= config.trailSpeed; 
                this.alpha -= config.trailDecay; 
            }
            draw(ctx) {
                ctx.save(); ctx.globalAlpha = Math.max(0, this.alpha);
                
                if(this.type === "Comet") {
                    ctx.fillStyle = this.cometColor;
                    ctx.beginPath(); ctx.arc(this.x, this.y, this.size/3, 0, Math.PI*2); ctx.fill();
                } 
                else if (this.type === "â™¥" || this.type === "â­") {
                    ctx.translate(this.x, this.y);
                    
                    if(this.type === "â™¥") {
                        // 2D Vivid Heart
                        ctx.fillStyle = this.color;
                        ctx.font = `${this.size}px serif`;
                        ctx.fillText("â™¥", 0, 0);
                    } else {
                        // Star
                        ctx.fillStyle = this.color; // Colorful Stars
                        ctx.font = `${this.size}px serif`;
                        ctx.fillText("â­", 0, 0);
                    }
                } 
                else {
                    // Cloud
                    ctx.fillStyle = "rgba(255,255,255,0.9)";
                    ctx.font = `${this.size}px serif`;
                    ctx.fillText(this.type, this.x, this.y);
                }
                ctx.restore();
            }
            isDead() { return this.alpha <= 0; }
        }

        // --- 4. Input Handling ---
        let lastTap=0, lastTapX=null, lastTapY=null, isDragging=false, dragStart=0, startX, startY, lastDragSound=0;
        let lastCollabDragEmit = 0;
        const DOUBLE_TAP_WINDOW = 240; // tighten window to avoid false doubles
        const DOUBLE_TAP_DISTANCE = 40; // require taps to be near each other
        const collabClientId = (crypto.randomUUID && crypto.randomUUID()) || `client-${Date.now().toString(36)}-${Math.random().toString(16).slice(2)}`;
        const collabAlias = `you-${collabClientId.slice(0,6)}`;
        const collabSessionId = `${collabClientId}-${Date.now().toString(36)}`;
        let collabActive = false, collabTopic = null, collabSource = null;
        let collabRoomCode = '';
        let collabSeq = 0;
        let collabReady = false;
        let collabReconnectTimer = null;
        let collabBackoffMs = 1000;
        const collabQueue = [];
        const lastSeqBySender = {};
        let collabMasterId = null;
        let collabMasterTs = null;
        let collabMasterClaimTimer = null;
        let collabJoinTs = 0;
        let collabIsMaster = false;
        let collabHeartbeat = null;
        const collabRoleIndicator = document.getElementById('collab-role-indicator');

        touchPeer('local', 'You', { master: false, alias: 'You' });

        function updateCollabRoleLabel(text, intent = 'neutral') {
            if (!collabRoleIndicator) return;
            collabRoleIndicator.textContent = text;
            collabRoleIndicator.classList.remove('text-emerald-700', 'text-amber-700', 'text-gray-500');
            if (intent === 'master') collabRoleIndicator.classList.add('text-emerald-700');
            else if (intent === 'sub') collabRoleIndicator.classList.add('text-amber-700');
            else collabRoleIndicator.classList.add('text-gray-500');
            if (collabPeers.local) {
                collabPeers.local.master = intent === 'master';
                updatePeerList();
            }
        }

        function setBackgroundImageFromData(dataUrl, { persist = true, notifyOnFail = false } = {}) {
            if (!dataUrl) return false;
            let persisted = true;
            currentBgData = dataUrl;
            if (persist) {
                try { localStorage.setItem('garden_bg', dataUrl); }
                catch (err) {
                    persisted = false;
                    if (notifyOnFail) alert("Image applied! Note: This image is too large to save permanently, so it will reset if you refresh the page.");
                    console.warn("Image too large to persist; will reset on reload.", err);
                }
            }
            const img = new Image();
            img.onload = ()=>{config.backgroundImage=img;config.useGradient=false;};
            img.src = dataUrl;
            return persisted;
        }

        function resetBackgroundToGradient({ persist = true } = {}) {
            if (persist) localStorage.removeItem('garden_bg');
            currentBgData = null;
            config.useGradient = true;
            config.backgroundImage = null;
        }

        function getBackgroundStatePayload() {
            return {
                useGradient: config.useGradient,
                imageData: config.useGradient ? null : currentBgData,
                masterId: collabMasterId || collabClientId,
                ts: Date.now()
            };
        }

        function applyBackgroundStateFromMaster(payload) {
            if (!payload) return;
            if (payload.useGradient || !payload.imageData) resetBackgroundToGradient();
            else setBackgroundImageFromData(payload.imageData);
            appendSessionLog('background', payload.useGradient ? 'Gradient restored from master.' : 'Background synced from master.');
        }

        function broadcastBackgroundUpdate(targetId = null) {
            if (!collabActive || !collabIsMaster) return;
            emitCollabEvent('bg-update', { ...getBackgroundStatePayload(), target: targetId });
        }

        function claimMasterRole() {
            collabIsMaster = true;
            collabMasterId = collabClientId;
            collabMasterTs = collabJoinTs || Date.now();
            updateCollabRoleLabel(`Role: Master (room: ${collabRoomCode || 'â€”'})`, 'master');
            touchPeer('local', 'You', { master: true });
            appendSessionLog('collab', `Assumed master role for room ${collabRoomCode || 'â€”'}.`);
            emitCollabEvent('master-announce', { masterId: collabMasterId, ts: collabMasterTs, background: getBackgroundStatePayload() });
            publishManifest(collabMasterId, 'active');
        }

        function adoptMaster(masterId, ts, background) {
            const incomingTs = ts || Date.now();
            if (collabMasterId && collabMasterTs && incomingTs > collabMasterTs && collabMasterId !== masterId) return;
            if (collabMasterClaimTimer) clearTimeout(collabMasterClaimTimer);
            collabMasterId = masterId;
            collabMasterTs = incomingTs;
            collabIsMaster = masterId === collabClientId;
            if (collabIsMaster) {
                updateCollabRoleLabel(`Role: Master (room: ${collabRoomCode || 'â€”'})`, 'master');
                touchPeer('local', 'You', { master: true });
                publishManifest(collabMasterId, 'active');
            } else {
                updateCollabRoleLabel(`Role: Subordinate (room: ${collabRoomCode || 'â€”'})`, 'sub');
                touchPeer('local', 'You', { master: false });
            }
            appendSessionLog('collab', `Master set to ${masterId.slice(0,6)} for room ${collabRoomCode || 'â€”'}.`, { skipLog: !collabActive });
            if (!collabIsMaster && background) applyBackgroundStateFromMaster(background);
        }

        function scheduleMasterClaim() {
            if (collabMasterClaimTimer) clearTimeout(collabMasterClaimTimer);
            collabMasterClaimTimer = setTimeout(() => {
                resolveMasterClaim('negotiation');
            }, MASTER_NEGOTIATION_MS);
        }

        function requestBackgroundFromMaster() {
            if (!collabActive || collabIsMaster || !collabMasterId) return;
            emitCollabEvent('bg-request', { target: collabMasterId, requester: collabClientId });
        }

        function flushCollabQueue() {
            if (!collabReady || !collabQueue.length || !collabTopic) return;
            const evt = collabQueue.shift();
            const body = JSON.stringify(evt);
            fetch(`https://ntfy.sh/${collabTopic}`, { method: 'POST', body, headers: { 'Content-Type': 'application/json', 'Title': 'garden-collab' } })
                .then(() => { if (collabQueue.length) setTimeout(flushCollabQueue, 20); })
                .catch(() => { collabQueue.unshift(evt); collabReady = false; scheduleCollabReconnect(); });
        }

        function emitCollabEvent(kind, payload={}) {
            if (!collabActive || !collabTopic || payload.silentCollab) return;
            const event = { kind, ...payload, sender: collabClientId, alias: payload.alias || collabAlias, session: collabSessionId, room: collabRoomCode, seq: ++collabSeq, ts: Date.now() };
            collabQueue.push(event);
            flushCollabQueue();
        }

        function scheduleCollabReconnect() {
            if (collabReconnectTimer || !collabActive) return;
            collabReconnectTimer = setTimeout(() => {
                collabReconnectTimer = null;
                collabBackoffMs = Math.min(collabBackoffMs * 1.6, 15000);
                openCollabStream();
            }, collabBackoffMs);
        }

        function announcePresence(status = 'join', extra = {}) {
            emitCollabEvent('presence', { status, alias: collabAlias, masterId: collabMasterId, ...extra });
        }

        function openCollabStream() {
            if (!collabTopic) return;
            if (collabSource) collabSource.close();
            collabReady = false;
            collabSource = new EventSource(`https://ntfy.sh/${collabTopic}/sse`);
            collabSource.onopen = () => {
                collabReady = true;
                collabBackoffMs = 1000;
                updateCollabRoleLabel(`Role: Syncing... (room: ${collabRoomCode || 'â€”'})`);
                emitCollabEvent('master-ping', { ts: collabJoinTs });
                announcePresence('join');
                emitCollabEvent('bg-request', { requester: collabClientId });
                refreshMasterFromManifest('stream-open');
                scheduleMasterClaim();
                flushCollabQueue(); // resync any buffered actions
            };
            collabSource.onerror = () => {
                collabReady = false;
                scheduleCollabReconnect();
            };
            collabSource.onmessage = evt => {
                try {
                    const data = JSON.parse(evt.data || '{}');
                    if (!data.message) return;
                    const msg = JSON.parse(data.message);
                    if (msg.sender === collabClientId || msg.session === collabSessionId) return;
                    if (msg.room && msg.room !== collabRoomCode) return;
                    applyRemoteEvent(msg);
                } catch(e) { console.warn('collab parse error', e); }
            };
        }

        function connectCollab(roomCode) {
            if (!roomCode) return;
            collabRoomCode = roomCode.replace(/[^a-zA-Z0-9_-]/g, '').toLowerCase() || 'you-garden';
            collabTopic = `garden-${collabRoomCode}`;
            collabActive = true;
            collabIsMaster = false;
            collabMasterId = null;
            collabMasterTs = null;
            collabJoinTs = Date.now();
            collabSeq = 0;
            collabQueue.length = 0;
            Object.keys(lastSeqBySender).forEach(k => delete lastSeqBySender[k]);
            collabBackoffMs = 1000;
            updateCollabRoleLabel(`Role: Negotiating... (room: ${collabRoomCode})`);
            touchPeer('local', 'You', { master: false });
            appendSessionLog('collab', `Connecting to room ${collabRoomCode}...`);
            refreshMasterFromManifest('connect');
            if (collabHeartbeat) clearInterval(collabHeartbeat);
            collabHeartbeat = setInterval(() => announcePresence('ping'), 12000);
            openCollabStream();
        }

        function applyRemoteEvent(msg) {
            if (msg.target && msg.target !== collabClientId) return;
            const seqKey = msg.session || msg.sender;
            if (msg.seq) {
                const lastSeq = lastSeqBySender[seqKey] || 0;
                if (msg.seq <= lastSeq) return;
                lastSeqBySender[seqKey] = msg.seq;
            }
            const alias = msg.alias || (msg.sender ? msg.sender.slice(0,6) : 'peer');
            touchPeer(msg.sender, alias, { master: msg.masterId ? msg.sender === msg.masterId : msg.sender === collabMasterId });
            if (msg.kind === 'tap') {
                appendSessionLog('collab-tap', `${alias} tapped`, { skipLog: false });
                simulateTap(msg.x, msg.y, { silentCollab: true, forceDouble: msg.double, sharedWord: msg.word, sharedVisual: msg.visual, skipTelemetry: true });
            }
            else if (msg.kind === 'drag') {
                appendSessionLog('collab-drag', `${alias} dragged`, { skipLog: false });
                simulateDrag(msg.x1, msg.y1, msg.x2, msg.y2, { silentCollab: true, sharedTrail: msg.trail, skipTelemetry: true });
            }
            else if (msg.kind === 'presence') {
                if (msg.background) applyBackgroundStateFromMaster(msg.background);
                if (collabIsMaster) {
                    emitCollabEvent('master-announce', { masterId: collabMasterId, ts: collabMasterTs, background: getBackgroundStatePayload(), target: msg.sender });
                    broadcastBackgroundUpdate(msg.sender);
                } else if (!collabMasterId && msg.masterId) {
                    adoptMaster(msg.masterId, msg.ts, msg.background);
                }
                if (msg.status === 'join') appendSessionLog('collab', `${alias} joined room ${collabRoomCode || 'â€”'}.`);
            }
            else if (msg.kind === 'master-announce') {
                adoptMaster(msg.masterId || msg.sender, msg.ts, msg.background);
                if (!msg.background) requestBackgroundFromMaster();
            }
            else if (msg.kind === 'master-ping') {
                if (collabIsMaster) emitCollabEvent('master-announce', { masterId: collabMasterId, ts: collabMasterTs, background: getBackgroundStatePayload() });
            }
            else if (msg.kind === 'bg-request') {
                if (collabIsMaster && (!msg.target || msg.target === collabMasterId)) broadcastBackgroundUpdate();
            }
            else if (msg.kind === 'bg-update') {
                if (msg.target && msg.target !== collabClientId) return;
                const senderMaster = msg.masterId || msg.sender;
                if (!collabMasterId) adoptMaster(senderMaster, msg.ts, msg);
                else if (senderMaster !== collabMasterId) {
                    if (!collabMasterTs || (msg.ts && msg.ts < collabMasterTs)) adoptMaster(senderMaster, msg.ts, msg);
                    else return;
                }
                applyBackgroundStateFromMaster(msg);
            }
        }

        // Immediate Audio Wake Up
        function wakeAudio() {
            ZenAudio.warmUp();
            document.removeEventListener('touchstart', wakeAudio);
            document.removeEventListener('mousedown', wakeAudio);
        }
        document.addEventListener('touchstart', wakeAudio, {passive: false});
        document.addEventListener('mousedown', wakeAudio);

        function handleInputStart(x,y, options = {}) { 
            ZenAudio.warmUp(); // Instant engagement
            document.getElementById('overlay').style.opacity='0'; 
            startX=x; startY=y; 
            dragStart=Date.now(); 
            isDragging=false; 
        }
        
        function handleInputMove(x,y, options = {}) {
            if(!startX) return;
            if(Math.sqrt((x-startX)**2 + (y-startY)**2) > 10) {
                isDragging=true;
                
                // Trail Logic: Switch randomly every 10s
                if(!options.sharedTrail && Date.now() - config.lastTrailSwitch > 10000) {
                    const options = ['â™¥', 'Comet', 'â˜ï¸', 'â­'];
                    if (config.currentTrail !== 'â™¥' && Math.random() > 0.4) {
                        config.currentTrail = 'â™¥';
                    } else {
                        config.currentTrail = options[Math.floor(Math.random() * options.length)];
                    }
                    config.lastTrailSwitch = Date.now();
                }

                const trailType = options.sharedTrail || config.currentTrail;
                visualEntities.push(new TrailBase(x, y, trailType));
                
                // Fluid Strumming on Drag
                if(Date.now()-lastDragSound > 60) { 
                    const idx = ZenAudio.getFreqIndex(y, height);
                    ZenAudio.playPluck(ZenAudio.scale[idx], 0.1); 
                    lastDragSound=Date.now(); 
                }
                if (!options.silentCollab && Date.now() - lastCollabDragEmit > 120) {
                    emitCollabEvent('drag', { x1: startX, y1: startY, x2: x, y2: y, trail: trailType, alias: collabAlias, silentCollab: options.silentCollab });
                    lastCollabDragEmit = Date.now();
                }
            }
        }

        function handleInputEnd(x,y, options = {}) {
            const now = Date.now();
            if(isDragging) { 
                if (!options.skipTelemetry) registerInput('S'); 
                checkDragUnlock(now-dragStart); 
                const trailType = options.sharedTrail || config.currentTrail;
                if (!options.skipTelemetry) appendSessionLog('drag', `Drag to ${Math.round(x)}, ${Math.round(y)} (${trailType})`, options);
                emitCollabEvent('drag', { x1: startX, y1: startY, x2: x, y2: y, trail: trailType, alias: collabAlias, silentCollab: options.silentCollab });
            } else {
                const idx = ZenAudio.getFreqIndex(y, height);
                const freq = ZenAudio.scale[idx];
                const visualKind = options.sharedVisual || (() => {
                    const rnd = Math.random();
                    if(foundEggs.includes(3) && rnd > 0.7) return 'growing-heart';
                    if(foundEggs.includes(3) && rnd > 0.5) return 'heart-bloom';
                    return 'bloom';
                })();
                const wordChoice = options.sharedWord || getRandomWord();

                const ent = visualKind === 'growing-heart' ? new GrowingHeart(x,y)
                            : visualKind === 'heart-bloom' ? new HeartBloom(x,y)
                            : new Bloom(x,y);

                visualEntities.push(ent);
                wordEntities.push(new Word(x,y-30, wordChoice));
                
                ZenAudio.playPluck(freq, 0.3);
                
                if (!options.skipTelemetry) {
                    window.telemetryStats.taps++;
                    registerInput('T');
                }

                const isNearLastTap = lastTapX !== null && lastTapY !== null && Math.hypot(x - lastTapX, y - lastTapY) <= DOUBLE_TAP_DISTANCE;
                const isDoubleTap = options.forceDouble || ((now - lastTap) < DOUBLE_TAP_WINDOW && isNearLastTap);

                if(isDoubleTap) {
                    visualEntities.push(new HeartCloud(x,y));
                    ZenAudio.playChord(idx);
                    if (!options.skipTelemetry) window.telemetryStats.drags++;
                    appendSessionLog('tap', `Tap at ${Math.round(x)}, ${Math.round(y)} [double]`, options);
                    emitCollabEvent('tap', { x, y, word: wordChoice, visual: visualKind, double: true, alias: collabAlias, silentCollab: options.silentCollab });
                } else {
                    appendSessionLog('tap', `Tap at ${Math.round(x)}, ${Math.round(y)} (${visualKind})`, options);
                    emitCollabEvent('tap', { x, y, word: wordChoice, visual: visualKind, double: false, alias: collabAlias, silentCollab: options.silentCollab });
                }
                lastTap = now;
                lastTapX = x;
                lastTapY = y;
            }
            startX=null; isDragging=false;
        }
        
        canvas.addEventListener('mousedown',e=>handleInputStart(e.clientX,e.clientY));
        canvas.addEventListener('mousemove',e=>{if(startX)handleInputMove(e.clientX,e.clientY)});
        canvas.addEventListener('mouseup',e=>handleInputEnd(e.clientX,e.clientY));
        canvas.addEventListener('touchstart',e=>{e.preventDefault();handleInputStart(e.touches[0].clientX,e.touches[0].clientY)},{passive:false});
        canvas.addEventListener('touchmove',e=>{e.preventDefault();if(startX)handleInputMove(e.touches[0].clientX,e.touches[0].clientY)},{passive:false});
        canvas.addEventListener('touchend',e=>{e.preventDefault();if(e.changedTouches.length)handleInputEnd(e.changedTouches[0].clientX,e.changedTouches[0].clientY)});

        function simulateTap(x, y, options = {}) {
            handleInputStart(x, y, options);
            setTimeout(() => handleInputEnd(x, y, options), 30);
        }

        function simulateDrag(x1, y1, x2, y2, options = {}) {
            const steps = 6;
            handleInputStart(x1, y1, options);
            for (let i=1; i<=steps; i++) {
                const t = i/steps;
                setTimeout(() => handleInputMove(x1 + (x2 - x1)*t, y1 + (y2 - y1)*t, options), t * 400);
            }
            setTimeout(() => handleInputEnd(x2, y2, options), 450);
        }

        // --- 5. Secrets Logic ---
        const rhythmSequences = [
            { code: "TTT", id: 1, desc: "Tap Tap Tap", title: "Jewel Core" }, 
            { code: "TTS", id: 2, desc: "Tap Tap Swipe", title: "Gold Filigree" }, 
            { code: "TST", id: 3, desc: "Tap Swipe Tap", title: "Amour Bloom & Heart 3D" }, 
            { code: "SST", id: 4, desc: "Swipe Swipe Tap", title: "Dimension Heart" }, 
            { code: "TTTT", id: 5, desc: "Tap Tap Tap Tap", title: "Stardust Legacy" }, 
            { code: "SS", id: 6, desc: "Swipe Swipe", title: "Removed (You)" },
            { code: "TSTS", id: 7, desc: "Tap Swipe Tap Swipe", title: "Secret 7" }, 
            { code: "STST", id: 8, desc: "Swipe Tap Swipe Tap", title: "Secret 8" }, 
            { code: "TSS", id: 9, desc: "Tap Swipe Swipe", title: "Secret 9" }, 
            { code: "SSS", id: 10, desc: "Swipe Swipe Swipe", title: "Secret 10" }
        ];

        function registerInput(char) {
            inputBuffer += char; if(inputBuffer.length>5) inputBuffer=inputBuffer.slice(-5);
            rhythmSequences.forEach(seq => { if(inputBuffer.endsWith(seq.code)) triggerUnlock(seq.id); });
        }
        function checkDragUnlock(dur) {
            const sec = 10 + Math.floor(dur/1000) - 1;
            if(sec>10 && sec<=20) triggerUnlock(sec);
        }
        function triggerUnlock(id) {
            inputBuffer="";
            if(!foundEggs.includes(id)) {
                foundEggs.push(id); localStorage.setItem('garden_egg_ids', JSON.stringify(foundEggs));
                
                let b = new Bloom(width/2, height/2, 200);
                if(id===3) b = new GrowingHeart(width/2, height/2); 
                visualEntities.push(b);
                
                // TELEMETRY SECRET
                window.telemetryStats.secrets++;

                ZenAudio.playDiscovery(); 
                updateSecretsUI();
            }
        }

        // --- 6. Rendering ---
        function drawBackground(ctx, img, cw, ch) {
            if (!img.complete || img.naturalWidth === 0) return;
            const scale = Math.max(cw / img.width, ch / img.height);
            const x = (cw / 2) - (img.width / 2) * scale;
            const y = (ch / 2) - (img.height / 2) * scale;
            ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
        }

        const TARGET_FRAME_MS = 1000 / 60;
        let lastFrameTime = performance.now();

        function loop(timestamp) {
            const delta = timestamp - lastFrameTime;

            if (delta >= TARGET_FRAME_MS) {
                lastFrameTime = timestamp - (delta % TARGET_FRAME_MS);

                // Note: width/height are logical pixels from resize()
                // ctx is already scaled by dpr, so we draw using logical coordinates
                
                if(config.useGradient || !config.backgroundImage) {
                    const t=themes[config.currentThemeIndex]; const g=ctx.createLinearGradient(0,0,0,height);
                    g.addColorStop(0,t.bg[0]); g.addColorStop(1,t.bg[1]); ctx.fillStyle=g; ctx.fillRect(0,0,width,height);
                } else {
                    drawBackground(ctx, config.backgroundImage, width, height);
                }

                for(let i=visualEntities.length-1; i>=0; i--) { visualEntities[i].update(); if(visualEntities[i].isDead()) visualEntities.splice(i,1); }
                for(let i=wordEntities.length-1; i>=0; i--) { wordEntities[i].update(); if(wordEntities[i].isDead()) wordEntities.splice(i,1); }
                for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(ctx); if(particles[i].isDead()) particles.splice(i,1); }

                visualEntities.forEach(e => e.draw(ctx));
                wordEntities.forEach(w => w.draw(ctx));

                document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            }

            requestAnimationFrame(loop);
        }

        // --- 7. UI Logic ---
        const bgInput=document.getElementById('bg-upload-input');
        
        document.getElementById('apply-bg-btn').addEventListener('click', ()=>{
            if (collabActive && !collabIsMaster) { alert("Background is controlled by the room master. Ask them to update it."); return; }
            const f=bgInput.files[0]; if(!f){alert("Please select an image file first.");return;}
            const r=new FileReader(); 
            r.onload=e=>{ 
                setBackgroundImageFromData(e.target.result, { notifyOnFail: true });
                appendSessionLog('background', 'Applied custom background.');
                broadcastBackgroundUpdate();
            }; 
            r.readAsDataURL(f);
        });
        
        document.getElementById('reset-bg-btn').addEventListener('click', ()=>{ 
            if (collabActive && !collabIsMaster) { alert("Only the room master can reset the background."); return; }
            resetBackgroundToGradient();
            appendSessionLog('background', 'Background reset to gradient.');
            broadcastBackgroundUpdate();
        });
        if(currentBgData){ setBackgroundImageFromData(currentBgData, { persist: false }); }

        const panel=document.getElementById('settings-panel');
        document.getElementById('settings-trigger').onclick = ()=>panel.classList.remove('translate-x-full');
        document.getElementById('close-btn').onclick = ()=>panel.classList.add('translate-x-full');
        document.getElementById('audio-toggle').onchange=e=>ZenAudio.enabled=e.target.checked;
        
        document.getElementById('decay-slider').oninput=e=>config.decayValue=[0,0.002,0.005,0.01,0.02,0.05][e.target.value];
        document.getElementById('trail-slider').oninput=e=>{
            const val = parseInt(e.target.value);
            const decays = [0.1, 0.08, 0.06, 0.04, 0.02, 0.01, 0.008, 0.005, 0.002, 0.0005];
            const speeds = [3.0, 2.5, 2.0, 1.5, 1.0, 0.8, 0.6, 0.4, 0.2, 0.1];
            config.trailDecay = decays[val-1];
            config.trailSpeed = speeds[val-1];
        };
        document.getElementById('speed-slider').oninput=e=>config.speedMultiplier=0.2+(e.target.value/100)*1.8;
        
        document.getElementById('theme-btn').onclick=()=>config.currentThemeIndex=(config.currentThemeIndex+1)%themes.length;
        document.getElementById('clear-btn').onclick=()=>{visualEntities=[];wordEntities=[];particles=[];};
        document.getElementById('save-btn').onclick=()=>{const a=document.createElement('a');a.download='garden.png';a.href=canvas.toDataURL();a.click();};
        const cBox=document.getElementById('custom-words');
        cBox.value=localStorage.getItem('garden_words')||"";
        cBox.onblur=e=>{localStorage.setItem('garden_words',e.target.value);if(e.target.value==='6969')config.customWords=[...config.defaultWords,...secretWords];else config.customWords=e.target.value.split(',').filter(s=>s.trim());};
        document.getElementById('collab-connect').onclick=()=>{
            const room = document.getElementById('collab-room').value.trim();
            connectCollab(room);
            document.getElementById('collab-connect').innerText = "Connected";
            document.getElementById('collab-connect').classList.add('bg-emerald-100');
        };

        const modals = {
            secrets: document.getElementById('secrets-modal'),
            code: document.getElementById('code-modal'),
            req: document.getElementById('req-modal'),
            autoplay: document.getElementById('autoplay-modal')
        };

        function toggleModal(id, show) {
            const el = modals[id];
            const content = el.querySelector('.modal-content') || el.querySelector('div');
            if(show) { 
                updateSecretsUI(); 
                el.classList.remove('invisible'); el.classList.add('visible');
                content.classList.remove('scale-out'); content.classList.add('scale-in');
                panel.classList.add('translate-x-full'); 
            } else { 
                el.classList.remove('visible'); el.classList.add('invisible');
                content.classList.remove('scale-in'); content.classList.add('scale-out');
            }
        }

        document.getElementById('secrets-btn').onclick=()=>toggleModal('secrets', true);
        document.getElementById('close-secrets').onclick=()=>toggleModal('secrets', false);
        document.getElementById('autoplay-btn').onclick=()=>toggleModal('autoplay', true);
        document.getElementById('close-autoplay').onclick=()=>toggleModal('autoplay', false);
        document.getElementById('info-btn').onclick=()=>{
            document.getElementById('source-code-display').textContent = document.documentElement.outerHTML;
            toggleModal('code', true);
        };
        document.getElementById('close-code').onclick=()=>toggleModal('code', false);
        document.getElementById('req-btn').onclick=()=>toggleModal('req', true);
        document.getElementById('close-req').onclick=()=>toggleModal('req', false);
        document.getElementById('copy-code-btn').onclick=()=>{
            navigator.clipboard.writeText(document.documentElement.outerHTML).then(() => {
                alert("Code copied to clipboard!");
            });
        };
        document.getElementById('back-to-grid').onclick=()=>{
            document.getElementById('secrets-detail-view').classList.add('hidden');
            document.getElementById('secrets-grid-view').classList.remove('hidden');
        };

        function updateSecretsUI() {
            const list=document.getElementById('secrets-list'); list.innerHTML='';
            for(let i=1; i<=20; i++) {
                const u = foundEggs.includes(i);
                const b = document.createElement('button');
                b.className = `aspect-square rounded flex items-center justify-center text-xs font-bold border transition-all ${u?'bg-amber-200 border-amber-400 text-amber-900 cursor-pointer hover:bg-amber-300':'bg-gray-100 text-gray-300 cursor-default'}`;
                b.innerText=i;
                if(u) b.onclick=()=>showDetail(i);
                list.appendChild(b);
            }
            document.getElementById('secrets-count').innerText=foundEggs.length;
        }

        function showDetail(id) {
            document.getElementById('secrets-grid-view').classList.add('hidden');
            document.getElementById('secrets-detail-view').classList.remove('hidden');
            document.getElementById('detail-id').innerText=id;
            const seq = rhythmSequences.find(s=>s.id===id);
            const trigger = seq ? seq.desc : `Drag ${id-9}s`;
            const title = seq ? (seq.title || "Secret Unlocked") : "Secret Unlocked";
            
            document.getElementById('detail-title').innerText = title;
            document.getElementById('detail-trigger').innerText = trigger;
            document.getElementById('detail-type').innerText = id<=10?"RHYTHM":"ENDURANCE";
            
            let rewardText = "Mystery Effect";
            if(id===1) rewardText = "Jewel Center (Soft Gradient)";
            if(id===2) rewardText = "Gold Filigree Leaves";
            if(id===3) rewardText = "Fractal Heart Blooms & 3D Hearts";
            if(id===4) rewardText = "Dimensional 3D Hearts";
            if(id===5) rewardText = "Stardust Legacy (Particles)";
            
            document.getElementById('detail-reward').innerText = rewardText;

            document.getElementById('simulate-btn').onclick = () => {
                toggleModal('secrets', false);
                setTimeout(() => {
                    if(id===3) visualEntities.push(new GrowingHeart(width/2, height/2));
                    else if(id===4) visualEntities.push(new HeartCloud(width/2, height/2));
                    else if(id===5) {
                        let b = new Bloom(width/2, height/2, 200);
                        b.alpha = 0.5; 
                        visualEntities.push(b);
                    }
                    else visualEntities.push(new Bloom(width/2, height/2, 200)); 
                    ZenAudio.playDiscovery();
                }, 300);
            };
        }

        // --- Auto-Play Studio ---
        const AUTO_STORAGE_KEY = 'garden_autoplay_settings';
        const AUTO_LIBRARY_KEY = 'garden_autoplay_files';
        const autoInputs = {
            rate: document.getElementById('auto-rate'),
            random: document.getElementById('auto-random'),
            chord: document.getElementById('auto-chord'),
            drags: document.getElementById('auto-drags'),
            soundscape: document.getElementById('auto-soundscape'),
            preset: document.getElementById('auto-preset')
        };
        const autoFileInputs = {
            prefix: document.getElementById('auto-file-prefix'),
            name: document.getElementById('auto-file-name'),
            chooser: document.getElementById('auto-file-chooser'),
            save: document.getElementById('auto-save-file'),
            load: document.getElementById('auto-load-file')
        };
        const autoToggleButton = document.getElementById('auto-toggle');
        const autoToggleLabel = document.getElementById('auto-toggle-label');
        const autoToggleIcon = document.getElementById('auto-toggle-icon');
        const autoRunIcon = document.getElementById('auto-run-icon');
        const autoplayBtn = document.getElementById('autoplay-btn');
        const autoLabels = {
            rate: document.getElementById('auto-rate-label'),
            random: document.getElementById('auto-random-label'),
            chord: document.getElementById('auto-chord-label')
        };
        let autoConfig = {
            rate: 60,
            random: 40,
            chord: 20,
            drags: false,
            soundscape: false,
            preset: 'balanced'
        };
        let autoTimer = null;
        let autoLibrary = [];
        let autoIconClickTimeout = null;

        function saveAutoConfig() { localStorage.setItem(AUTO_STORAGE_KEY, JSON.stringify(autoConfig)); }
        function loadAutoConfig() {
            try {
                const saved = JSON.parse(localStorage.getItem(AUTO_STORAGE_KEY) || '{}');
                autoConfig = { ...autoConfig, ...saved };
            } catch(e){}
            syncAutoUI();
        }
        function syncAutoUI() {
            autoInputs.rate.value = autoConfig.rate;
            autoInputs.random.value = autoConfig.random;
            autoInputs.chord.value = autoConfig.chord;
            autoInputs.drags.checked = autoConfig.drags;
            autoInputs.soundscape.checked = autoConfig.soundscape;
            autoInputs.preset.value = autoConfig.preset;
            autoLabels.rate.innerText = autoConfig.rate;
            autoLabels.random.innerText = `${autoConfig.random}%`;
            autoLabels.chord.innerText = `${autoConfig.chord}%`;
        }
        function loadAutoLibrary() {
            try {
                autoLibrary = JSON.parse(localStorage.getItem(AUTO_LIBRARY_KEY) || '[]');
                if (!Array.isArray(autoLibrary)) autoLibrary = [];
            } catch(e){ autoLibrary = []; }
            refreshAutoFileChooser();
        }
        function saveAutoLibrary() {
            localStorage.setItem(AUTO_LIBRARY_KEY, JSON.stringify(autoLibrary));
        }
        function refreshAutoFileChooser() {
            const prefix = (autoFileInputs.prefix.value || '').trim();
            const filtered = autoLibrary
                .filter(f => !prefix || f.name.startsWith(prefix))
                .sort((a,b)=>a.name.localeCompare(b.name));
            autoFileInputs.chooser.innerHTML = '';
            if (!filtered.length) {
                const opt = document.createElement('option');
                opt.textContent = 'No saved files for this prefix';
                opt.value = '';
                autoFileInputs.chooser.appendChild(opt);
                return;
            }
            filtered.forEach(file => {
                const opt = document.createElement('option');
                opt.value = file.name;
                opt.textContent = file.name;
                autoFileInputs.chooser.appendChild(opt);
            });
        }
        function setAutoPreset(name) {
            if (name === 'calm') autoConfig = { ...autoConfig, rate: 30, random: 20, chord: 10, drags: false, soundscape: true, preset: 'calm' };
            if (name === 'balanced') autoConfig = { ...autoConfig, rate: 60, random: 40, chord: 20, drags: false, soundscape: false, preset: 'balanced' };
            if (name === 'intense') autoConfig = { ...autoConfig, rate: 120, random: 60, chord: 35, drags: true, soundscape: true, preset: 'intense' };
            syncAutoUI(); saveAutoConfig();
        }
        function updateAutoRunUI() {
            const running = !!autoTimer;
            autoToggleLabel.innerText = running ? 'Stop' : 'Start';
            autoToggleIcon.innerText = running ? 'stop_circle' : 'play_arrow';
            autoToggleButton.classList.toggle('bg-indigo-600', !running);
            autoToggleButton.classList.toggle('bg-emerald-600', running);
            autoToggleButton.classList.toggle('hover:bg-indigo-700', !running);
            autoToggleButton.classList.toggle('hover:bg-emerald-700', running);
            autoRunIcon.classList.toggle('ring-4', running);
            autoRunIcon.classList.toggle('ring-emerald-300/60', running);
            autoRunIcon.classList.toggle('bg-emerald-500/80', running);
            autoRunIcon.classList.toggle('bg-indigo-500/80', !running);
            autoplayBtn.classList.toggle('bg-emerald-50', running);
            autoplayBtn.classList.toggle('text-emerald-700', running);
        }
        function autoLoop() {
            const interval = Math.max(200, 60000 / Math.max(1, autoConfig.rate));
            clearInterval(autoTimer);
            autoTimer = setInterval(() => {
                const jitter = autoConfig.random / 100;
                const x = random(40, width-40);
                const y = random(60, height-60);
                const silentOptions = { silentCollab: true, skipTelemetry: true, skipLog: true };
                const shouldDrag = autoConfig.drags && Math.random() < (0.1 + jitter*0.3);
                const shouldChord = Math.random() < (autoConfig.chord/100);
                if (shouldDrag) {
                    const x2 = x + random(-100, 100) * Math.max(0.5, jitter);
                    const y2 = y + random(-80, 120) * Math.max(0.5, jitter);
                    simulateDrag(x, y, Math.max(20, Math.min(width-20, x2)), Math.max(20, Math.min(height-20, y2)), silentOptions);
                } else {
                    simulateTap(x, y, { ...silentOptions, forceDouble: shouldChord && Math.random() < (0.5 + jitter/2) });
                }
                if (autoConfig.soundscape && Math.random() < 0.25) {
                    ZenAudio.playDiscovery();
                }
            }, interval);
            updateAutoRunUI();
        }
        function stopAutoLoop() {
            if (autoTimer) clearInterval(autoTimer);
            autoTimer = null;
            updateAutoRunUI();
        }
        function toggleAutoLoop() {
            if (autoTimer) stopAutoLoop();
            else autoLoop();
        }
        document.getElementById('auto-rate').oninput = e => { autoConfig.rate = parseInt(e.target.value); autoLabels.rate.innerText = autoConfig.rate; saveAutoConfig(); if(autoTimer) autoLoop(); };
        document.getElementById('auto-random').oninput = e => { autoConfig.random = parseInt(e.target.value); autoLabels.random.innerText = `${autoConfig.random}%`; saveAutoConfig(); if(autoTimer) autoLoop(); };
        document.getElementById('auto-chord').oninput = e => { autoConfig.chord = parseInt(e.target.value); autoLabels.chord.innerText = `${autoConfig.chord}%`; saveAutoConfig(); if(autoTimer) autoLoop(); };
        document.getElementById('auto-drags').onchange = e => { autoConfig.drags = e.target.checked; saveAutoConfig(); if(autoTimer) autoLoop(); };
        document.getElementById('auto-soundscape').onchange = e => { autoConfig.soundscape = e.target.checked; saveAutoConfig(); if(autoTimer) autoLoop(); };
        document.getElementById('auto-preset').onchange = e => setAutoPreset(e.target.value);
        document.getElementById('auto-save-preset').onclick = () => { autoConfig.preset = autoInputs.preset.value; saveAutoConfig(); };
        autoToggleButton.onclick = () => { toggleAutoLoop(); };
        autoRunIcon.addEventListener('click', () => {
            if (autoIconClickTimeout) return;
            autoIconClickTimeout = setTimeout(() => {
                toggleAutoLoop();
                autoIconClickTimeout = null;
            }, 200);
        });
        autoRunIcon.addEventListener('dblclick', (e) => {
            e.preventDefault();
            if (autoIconClickTimeout) { clearTimeout(autoIconClickTimeout); autoIconClickTimeout = null; }
            toggleModal('autoplay', true);
        });
        autoFileInputs.prefix.addEventListener('input', refreshAutoFileChooser);
        autoFileInputs.save.addEventListener('click', () => {
            const prefix = (autoFileInputs.prefix.value || '').trim();
            const name = (autoFileInputs.name.value || '').trim();
            if (!name) { alert('Please name your file before saving.'); return; }
            const fileName = `${prefix}${name}`;
            const existingIndex = autoLibrary.findIndex(f => f.name === fileName);
            const payload = { name: fileName, config: { ...autoConfig } };
            if (existingIndex >= 0) autoLibrary[existingIndex] = payload;
            else autoLibrary.push(payload);
            saveAutoLibrary();
            refreshAutoFileChooser();
            autoFileInputs.chooser.value = fileName;
        });
        autoFileInputs.load.addEventListener('click', () => {
            const selected = autoFileInputs.chooser.value;
            if (!selected) return;
            const file = autoLibrary.find(f => f.name === selected);
            if (!file) return;
            autoConfig = { ...autoConfig, ...file.config };
            syncAutoUI(); saveAutoConfig();
            if (autoTimer) autoLoop();
        });
        loadAutoConfig();
        loadAutoLibrary();
        updateAutoRunUI();

        // Recording
        let mediaRecorder, recordedChunks = [], isRecording = false;
        const recBtn = document.getElementById('record-btn');
        const recInd = document.getElementById('rec-indicator');
        
        recBtn.addEventListener('click', () => isRecording ? stopRecording() : startRecording());
        
        function startRecording() {
            // FULL RESET
            ZenAudio.init();
            
            // Clean up old instances if any
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            mediaRecorder = null;
            recordedChunks = [];

            if (ZenAudio.ctx && ZenAudio.ctx.state === 'suspended') {
                ZenAudio.ctx.resume();
            }

            // High Fidelity: Capture stream from the already scaled canvas
            const stream = canvas.captureStream(60); 
            
            // Re-connect fresh audio tracks (Including BG + SFX)
            // ZenAudio.dest receives everything connected to masterGain
            if (ZenAudio.dest && ZenAudio.dest.stream.getAudioTracks().length > 0) {
                const audioTrack = ZenAudio.dest.stream.getAudioTracks()[0].clone();
                stream.addTrack(audioTrack);
            }

            const mimeTypes = [
                "video/mp4", 
                "video/webm;codecs=h264", 
                "video/webm;codecs=vp9", 
                "video/webm"
            ];
            
            let selectedType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));

            if (!selectedType) { alert("Screen recording is not supported."); return; }

            try { mediaRecorder = new MediaRecorder(stream, { mimeType: selectedType }); } 
            catch (e) { console.error(e); alert("Recording init failed."); return; }

            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: selectedType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); 
                a.style.display="none"; a.href=url; 
                
                let ext = "webm";
                if (selectedType.includes("mp4")) ext = "mp4";
                
                a.download=`garden-${Date.now()}.${ext}`;
                document.body.appendChild(a); a.click(); 
                setTimeout(()=>URL.revokeObjectURL(url),100);
            };
            
            mediaRecorder.start(); isRecording = true; 
            recInd.style.opacity = '1'; recBtn.innerText = "Stop"; 
            recBtn.classList.add('bg-red-100','text-red-700','animate-pulse'); 
            panel.classList.add('translate-x-full');
        }

        function stopRecording() { 
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop(); 
            isRecording=false; recInd.style.opacity='0'; recBtn.innerText="Record"; 
            recBtn.classList.remove('bg-red-100','text-red-700','animate-pulse'); 
        }

        requestAnimationFrame(loop);
    </script>

    <script>
        // --- 1. CONFIGURATION ---
        const FORM_ID = "1FAIpQLSe3k3uGy3zjEIJ8QVDhjpQOG6EAjWCZ9pCFlhDKle8NeUhg9w"; // Your Real ID
        const MAPPING = {
            "entry.320935448": "@session_end_iso",
            "entry.674244912": "@theme_code",
            "entry.711998658": "@ip_address",
            "entry.463387935": "@session_id",
            "entry.856781419": "@duration_formatted",
            "entry.799073583": "@input_taps",
            "entry.1460702381": "@input_drags",
            "entry.1854966723": "@mouse_pixels_moved",
            "entry.406770144": "@user_agent",
            "entry.339302030": "@platform",
            "entry.1885869286": "@screen_resolution",
            "entry.1550217446": "@window_size",
            "entry.581200255": "@pixel_ratio",
            "entry.720549735": "@color_depth",
            "entry.1134789700": "@cores",
            "entry.1076432340": "@memory",
            "entry.854591687": "@language",
            "entry.101770949": "@timezone",
            "entry.2010953570": "@cookies_enabled",
            "entry.607664253": "@local_storage",
            "entry.1399187003": "@canvas_fingerprint",
            "entry.1854154093": "@referrer",
            "entry.1036649804": "@session_start_iso",
            "entry.1683490369": "@standard_words",
            "entry.1722638233": "@custom_words"
            ,"entry.527394232": "@session_log"
        };

        const START_TIME = Date.now();
        // C19: Local Time (Los Angeles)
        const c19_session_start_la = new Date(START_TIME).toLocaleString('sv', { timeZone: 'America/Los_Angeles' }).replace(' ', 'T');

        window.telemetryStats = { taps: 0, drags: 0, secrets: 0, mouseDist: 0 };
        let cachedIP = "pending";

        // --- 2. ASYNC IP FETCH ---
        fetch('https://api.ipify.org?format=json')
            .then(r => r.json()).then(d => cachedIP = d.ip).catch(e => cachedIP = "offline");

        // --- 3. MOUSE TRACKING ---
        let lastMouse = {x:0, y:0};
        document.addEventListener('mousemove', e => {
            if(lastMouse.x!==0) window.telemetryStats.mouseDist += Math.hypot(e.clientX-lastMouse.x, e.clientY-lastMouse.y);
            lastMouse = {x:e.clientX, y:e.clientY};
        });

        // --- 4. DATA COLLECTION & SEND ---
        const getCanvasFP = () => {
            try {
                const c = document.createElement('canvas'); const cx = c.getContext('2d');
                cx.textBaseline = "top"; cx.font = "14px 'Arial'"; cx.fillStyle = "#f60";
                cx.fillRect(125,1,62,20); cx.fillStyle = "#069"; cx.fillText("Garden", 2, 15);
                let b64 = c.toDataURL(); let hash=0; for(let i=0;i<b64.length;i++) hash=Math.imul(31,hash)+b64.charCodeAt(i)|0;
                return Math.abs(hash).toString(16);
            } catch(e) { return "err"; }
        };

        let logSent = false;
        const SESSION_LOG_CHAR_LIMIT = 1800;

        function buildSessionLogString() {
            return sessionLog
                .map(item => `[${new Date(item.ts).toISOString()}] ${item.type}: ${item.detail}`)
                .join(' | ')
                .slice(-SESSION_LOG_CHAR_LIMIT);
        }

        async function sendToPipeline(formData) {
            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;
            try {
                if (navigator.sendBeacon) {
                    const params = new URLSearchParams();
                    formData.forEach((v,k)=>params.append(k,v));
                    if (navigator.sendBeacon(url, params)) return true;
                }
            } catch(e) {
                console.warn('Beacon send failed, falling back to fetch', e);
            }
            try {
                await fetch(url, { method: 'POST', mode: 'no-cors', body: formData, keepalive: true });
                return true;
            } catch(e) {
                console.warn('Pipeline fetch failed', e);
                return false;
            }
        }

        async function logSession() {
            if (logSent) return;
            logSent = true;
            pipelineSendCount += 1;
            setPipelineStatus('Sending...', 'warn');
            const now = Date.now();
            const duration = (now - START_TIME) / 1000;
            const standardWordsString = config.defaultWords.join(', ');
            const customWordsRaw = (config.customWords && config.customWords.length)
                ? config.customWords
                : (typeof cBox !== 'undefined' ? cBox.value.split(',').map(s=>s.trim()).filter(Boolean) : []);
            const customWordsString = customWordsRaw.filter(Boolean).join(', ');
            const dataLayer = {
                "@session_start_iso": new Date(START_TIME).toISOString(),
                "@start_time_la": c19_session_start_la, // C19 Data
                "@session_end_iso": new Date(now).toISOString(),
                "@duration_formatted": `${Math.floor(duration/60)}m ${Math.floor(duration%60)}s`,
                "@ip_address": cachedIP,
                "@session_id": START_TIME.toString(36),
                "@theme_code": "DEFAULT",
                "@user_agent": navigator.userAgent,
                "@screen_resolution": `${window.screen.width}x${window.screen.height}`,
                "@window_size": `${window.innerWidth}x${window.innerHeight}`,
                "@pixel_ratio": window.devicePixelRatio || 1,
                "@color_depth": window.screen.colorDepth,
                "@cores": navigator.hardwareConcurrency || "ukn",
                "@memory": navigator.deviceMemory || "ukn",
                "@platform": navigator.platform,
                "@language": navigator.language,
                "@timezone": Intl.DateTimeFormat().resolvedOptions().timeZone,
                "@cookies_enabled": navigator.cookieEnabled,
                "@local_storage": (typeof localStorage !== 'undefined') ? 'available' : 'blocked',
                "@canvas_fingerprint": getCanvasFP(),
                "@referrer": document.referrer || "direct",
                "@input_taps": window.telemetryStats.taps,
                "@input_drags": window.telemetryStats.drags,
                "@mouse_pixels_moved": Math.round(window.telemetryStats.mouseDist),
                "@secrets_found_count": window.telemetryStats.secrets,
                "@standard_words": standardWordsString,
                "@custom_words": customWordsString
                ,"@session_log": buildSessionLogString()
            };

            const formData = new FormData();
            for (const [entryId, token] of Object.entries(MAPPING)) {
                let val = token.replace(/@\w+/g, match => dataLayer[match] !== undefined ? dataLayer[match] : match);
                formData.append(entryId, val);
            }

            const ok = await sendToPipeline(formData);
            if (ok) {
                setPipelineStatus(`Sent (${pipelineSendCount})`, 'success');
                appendSessionLog('pipeline', 'Session log submitted.');
            } else {
                setPipelineStatus('Send failed', 'error');
                appendSessionLog('pipeline', 'Session log failed to submit.', { skipLog: false });
            }
        }

        window.addEventListener('beforeunload', logSession);
        window.addEventListener('pagehide', logSession);
        window.addEventListener('visibilitychange', () => { if(document.visibilityState === 'hidden') logSession(); });
    </script>

    <script>
        const AppState = { bgImage: null, useGradient: true };
        function sanitizeSplashText(value) {
            if (!value) return '';
            const trimmed = value.toString().trim();
            if (!trimmed) return '';
            const lowered = trimmed.toLowerCase();
            const forbiddenTokens = [
                'doctype', '<html', '</html', '<meta', '</meta', '<head', '</head', '<body', '</body',
                'minimum-scale', 'maximum-scale', 'width=device-width'
            ];
            if (forbiddenTokens.some(token => lowered.includes(token))) return '';
            if (trimmed.length > 240) return '';
            if (/[<>]/.test(trimmed)) return '';
            const div = document.createElement('div');
            div.textContent = trimmed;
            return div.textContent;
        }
        async function fetchRemoteSplash() {
            if (!GOOGLE_SHEET_SPLASH_CSV || GOOGLE_SHEET_SPLASH_CSV.includes("YOUR_SHEET_ID")) return;
            try {
                const r = await fetch(GOOGLE_SHEET_SPLASH_CSV, { cache: 'no-store' });
                if (!r.ok) return;
                const csv = await r.text();
                const firstLine = (csv.split(/\r?\n/).find(l => l.trim()) || "").split(',');
                const title = sanitizeSplashText(firstLine[0]);
                if (title) document.getElementById('main-title').textContent = title;
                const subtitle = sanitizeSplashText(firstLine[1]);
                if (subtitle) document.getElementById('main-subtitle-container').textContent = subtitle;
                const message = sanitizeSplashText(firstLine.slice(2).join(','));
                if (message) {
                    const b = document.getElementById('custom-message-container');
                    b.textContent = message;
                    b.classList.remove('hidden');
                }
            } catch(e) { console.warn('splash fetch failed', e); }
        }
        async function initEnvironment() {
            // Text
            try {
                const r = await fetch('msg.txt');
                if (r.ok) {
                    const text = await r.text();
                    const parts = text.split('|');
                    const title = sanitizeSplashText(parts[0]);
                    if(title) document.getElementById('main-title').textContent = title;
                    const subtitle = sanitizeSplashText(parts[1]);
                    if(subtitle) document.getElementById('main-subtitle-container').textContent = subtitle;
                    const message = sanitizeSplashText(parts[2]);
                    if(message) {
                        const b = document.getElementById('custom-message-container');
                        b.textContent = message; b.classList.remove('hidden');
                    }
                }
            } catch(e){}
            fetchRemoteSplash();
            // Audio
            try {
                const r = await fetch('sound.mp3', {method:'HEAD'});
                if(r.ok) {
                    // Added crossorigin for Web Audio security
                    const a = document.createElement('audio'); 
                    a.id='bg-audio-track'; 
                    a.loop=true; 
                    a.src='sound.mp3'; 
                    a.volume=0.2; 
                    a.crossOrigin = "anonymous"; 
                    document.body.appendChild(a);
                    
                    const unlock = ()=>{ 
                        // Route to Web Audio for Recording Sync
                        ZenAudio.connectBackground(a);
                        a.play().catch(()=>{}); 
                        document.removeEventListener('click', unlock); 
                        document.removeEventListener('touchstart', unlock); 
                    };
                    document.addEventListener('click', unlock); document.addEventListener('touchstart', unlock);
                }
            } catch(e){}
            // Image
            for(const ext of ['png','jpg','jpeg','gif']) {
                try {
                    const r = await fetch(`img.${ext}`, {method:'HEAD'});
                    if(r.ok) {
                        const i = new Image(); i.onload = ()=>{ AppState.bgImage=i; AppState.useGradient=false; }; i.src=`img.${ext}`; break;
                    }
                } catch(e){}
            }
        }
        initEnvironment();
    </script>
</body>
</html>
