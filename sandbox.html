<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub Pages ntfy Chat Demo</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background: #0b132b; color: #e5e7eb; }
    .shell { max-width: 720px; margin: 32px auto; padding: 20px; background: #111827; border-radius: 16px; border: 1px solid #1f2937; }
    h1 { margin: 0 0 6px; }
    .status { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #1f2937; margin-bottom: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #f59e0b; box-shadow: 0 0 0 0 rgba(245,158,11,0.6); animation: pulse 1.5s infinite; }
    .status.ok .dot { background: #34d399; }
    .status.error .dot { background: #f87171; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,255,255,0.35);} 70% { box-shadow: 0 0 0 12px rgba(255,255,255,0);} 100% { box-shadow: 0 0 0 0 rgba(255,255,255,0);} }
    .log { border: 1px solid #1f2937; border-radius: 12px; background: #0f172a; min-height: 240px; padding: 12px; overflow: auto; }
    .msg { padding: 8px 10px; margin-bottom: 8px; border-radius: 10px; background: #0b1223; }
    .meta { color: #9ca3af; font-size: 12px; }
    .row { display: flex; gap: 8px; margin-top: 12px; }
    input { flex: 1; padding: 10px 12px; border-radius: 10px; border: 1px solid #1f2937; background: #0f172a; color: #fff; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #1f2937; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #fff; cursor: pointer; font-weight: 600; }
    small { color: #9ca3af; }
  </style>
</head>
<body>
  <div class="shell">
    <h1>Two-Device Chat (ntfy.sh)</h1>
    <div class="status" id="status"><span class="dot"></span><span class="label">Connecting…</span></div>
    <div class="log" id="log"></div>
    <div class="row">
      <input id="input" type="text" placeholder="Type a message and press Send" />
      <button id="send">Send</button>
    </div>
    <small>Share this URL with ?session=demo-fixed (or change it). Open in two browser tabs/devices on GitHub Pages to see instant cross-tab chat.</small>
  </div>

  <script>
    (() => {
      const statusEl = document.getElementById('status');
      const statusLabel = statusEl.querySelector('.label');
      const log = document.getElementById('log');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('send');

      let session, topic, source, reconnectTimer;
      let lastSeenId = null;
      let lastSeenTs = 0;

      function setStatus(text, state = 'retry') {
        statusLabel.textContent = text;
        statusEl.classList.remove('ok', 'error', 'retry');
        statusEl.classList.add(state);
      }

      function resolveSession() {
        const url = new URL(window.location.href);
        const fromUrl = url.searchParams.get('session');
        session = (fromUrl && fromUrl.trim()) || 'demo-fixed';
        url.searchParams.set('session', session);
        history.replaceState(null, '', url.toString());
        topic = `garden-demo-${session}`;
      }

      function appendMessage({ from, text, ts }) {
        const row = document.createElement('div');
        row.className = 'msg';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = `${from} • ${new Date(ts).toLocaleTimeString()}`;
        const body = document.createElement('div');
        body.textContent = text;
        row.append(meta, body);
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
      }

      function handleMessage({ payload, id, time }) {
        if (!payload || payload.session !== session) return;
        if (id && id === lastSeenId) return;
        const ts = time ? time * 1000 : (payload.ts || Date.now());
        if (!id && ts <= lastSeenTs) return;
        lastSeenId = id || lastSeenId;
        lastSeenTs = Math.max(lastSeenTs, ts);
        appendMessage({ from: payload.sender || 'Peer', text: payload.text || '', ts });
      }

      function connect() {
        if (!topic) return;
        if (source) { source.close(); source = null; }
        clearTimeout(reconnectTimer);
        setStatus('Connecting…', 'retry');
        source = new EventSource(`https://ntfy.sh/${topic}/sse`);
        source.onopen = () => setStatus('Connected', 'ok');
        source.onerror = () => {
          setStatus('Retrying…', 'retry');
          if (source) { source.close(); source = null; }
          reconnectTimer = setTimeout(connect, 1200);
        };
        source.onmessage = evt => {
          try {
            const envelope = JSON.parse(evt.data);
            const payload = typeof envelope.message === 'string' ? JSON.parse(envelope.message) : envelope;
            handleMessage({ payload, id: envelope.id, time: envelope.time });
          } catch (e) {
            console.warn('parse error', e);
          }
        };
      }

      function send() {
        if (!session || !topic) return;
        const text = input.value.trim();
        if (!text) return;
        const payload = { session, text, sender: 'Me', ts: Date.now() };
        appendMessage({ from: 'Me', text, ts: payload.ts });
        fetch(`https://ntfy.sh/${topic}`, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        }).catch(() => setStatus('Send failed', 'error'));
        input.value = '';
      }

      resolveSession();
      connect();

      sendBtn.addEventListener('click', send);
      input.addEventListener('keydown', e => { if (e.key === 'Enter') send(); });

      // Drop a starter message for quick proof on initial load
      if (!session.includes('demo-starter-sent')) {
        setTimeout(() => {
          input.value = 'Hello from this device!';
          send();
        }, 600);
      }
    })();
  </script>
</body>
</html>
