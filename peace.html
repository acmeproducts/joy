<!-- A Time to Relax - v13.3 - 2025-12-13 12:45 AM - PERFECT SYNC -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
    <title>A Time to Relax</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        body {
            touch-action: none;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
            background-color: #000;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%; background: #8ec5fc;
            cursor: pointer; margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer;
            background: #e2e8f0; border-radius: 2px;
        }
        
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal.invisible { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        
        .modal-content { transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .scale-in { transform: scale(1); }
        .scale-out { transform: scale(0.95); }

        pre { white-space: pre-wrap; word-wrap: break-word; }
        
        #custom-message-container { pointer-events: auto; }
        #custom-message-container a { color: #8ec5fc; text-decoration: underline; }
    </style>
</head>
<body class="overflow-hidden h-screen w-screen font-sans text-slate-800">

    <canvas class="block absolute top-0 left-0 w-full h-full z-0" id="gameCanvas"></canvas>

    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10 transition-opacity duration-1000 opacity-100 text-white/90 text-center drop-shadow-md" id="overlay">
        <h1 class="text-3xl md:text-5xl font-light mb-4 tracking-widest" id="main-title">A Time to Relax</h1>
        <div id="main-subtitle-container">
            <p class="text-lg md:text-xl font-light leading-relaxed">
                Tap to Bloom<br>
                Double Tap for Hearts<br>
                <span class="text-sm opacity-70 mt-2 block">Drag to Strum</span>
            </p>
        </div>
        <div id="custom-message-container" class="mt-4 hidden bg-black/30 p-4 rounded-lg backdrop-blur-sm max-w-lg text-sm text-left"></div>
    </div>

    <div class="fixed top-5 left-5 flex items-center gap-2 bg-black/40 backdrop-blur px-3 py-2 rounded-full text-white text-xs font-bold tracking-wide opacity-0 transition-opacity z-50 pointer-events-none" id="rec-indicator">
        <div class="w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse"></div>
        REC
    </div>

    <div class="fixed top-5 left-24 flex items-center gap-2 bg-black/40 backdrop-blur px-3 py-2 rounded-full text-white text-xs font-bold tracking-wide opacity-0 transition-opacity z-50 pointer-events-none" id="sync-indicator">
        <div class="w-2.5 h-2.5 bg-amber-400 rounded-full animate-pulse"></div>
        SYNCING
    </div>

    <button class="fixed top-16 left-5 px-3 py-1.5 rounded-full text-[10px] font-semibold tracking-wider uppercase bg-white/20 text-white/80 backdrop-blur opacity-0 pointer-events-none transition-opacity z-50" id="reconnect-now">
        Reconnect now
    </button>

    <div class="fixed top-16 left-24 px-3 py-1.5 rounded-full text-[10px] font-semibold tracking-wide bg-black/40 text-white/80 backdrop-blur opacity-0 transition-opacity z-50 pointer-events-none" id="ui-notice"></div>

    <div class="fixed bottom-3 right-4 text-[10px] text-white/60 pointer-events-none z-10 tracking-wider" id="master-footer">
      ‚Ä¢ A Time to Relax ‚Ä¢ Penang 2025 ‚Ä¢ <span id="clock">--:--</span>
    </div>

    <button class="fixed top-5 right-5 w-12 h-12 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white hover:bg-white/30 active:scale-95 transition-all shadow-lg z-50" id="settings-trigger">
        <span class="material-symbols-outlined">settings</span>
    </button>

    <aside class="fixed top-0 right-0 w-80 h-full bg-white/95 backdrop-blur-xl shadow-2xl transform transition-transform duration-300 translate-x-full z-50 flex flex-col no-scrollbar overflow-y-auto" id="settings-panel">
        
        <div class="p-6 flex justify-between items-center border-b border-gray-100">
            <h2 class="text-lg font-bold text-gray-700 tracking-wide uppercase">Settings</h2>
            <button class="text-gray-400 hover:text-gray-700 transition-colors" id="close-btn">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>

        <div class="p-6 space-y-8 flex-1">

            <div class="space-y-3">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Your Session</span>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-3">
                    <div class="flex items-center justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-sm font-semibold text-gray-700 truncate" id="local-name-display">--</div>
                            <div class="text-[10px] uppercase tracking-wider text-gray-400">Logged in name</div>
                        </div>
                        <div class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-wider text-gray-500">
                            <span id="local-status-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-400"></span>
                            <span id="local-status-label">Active</span>
                        </div>
                    </div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider block" for="local-name-input">Display name</label>
                    <div class="flex items-center gap-2">
                        <input id="local-name-input" type="text" maxlength="40" class="flex-1 px-3 py-2 text-xs border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300" placeholder="Your name">
                        <button id="update-name-btn" class="px-3 py-2 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition">Update</button>
                    </div>
                    <div class="text-[10px] text-gray-400">This name is visible to peers and confirms your presence.</div>
                </div>
            </div>

            <div class="space-y-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Session Status</span>
                <ul id="session-status-list" class="space-y-2 text-xs text-gray-600">
                    <li class="text-[11px] text-gray-400">No peers yet.</li>
                </ul>
                <button class="mt-3 w-full flex items-center justify-center gap-2 px-3 py-2 bg-slate-100 text-slate-700 text-xs font-semibold rounded-lg hover:bg-slate-200 transition" id="session-log-btn">
                    <span class="material-symbols-outlined text-base">receipt_long</span>
                    View Session Log
                </button>
            </div>
            
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Sound</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="audio-toggle" class="sr-only peer" checked>
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-300"></div>
                </label>
            </div>

            <div class="space-y-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Musical Scale</span>
                <select id="scale-selector" class="w-full px-4 py-2.5 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 cursor-pointer">
                    <option value="extended_pentatonic">Extended Pentatonic (18 notes)</option>
                    <option value="original">Original Scale (13 notes)</option>
                    <option value="major_pentatonic">Major Pentatonic</option>
                    <option value="minor_pentatonic">Minor Pentatonic</option>
                    <option value="chromatic">Chromatic</option>
                    <option value="whole_tone">Whole Tone</option>
                    <option value="blues">Blues Scale</option>
                </select>
            </div>

            <div class="space-y-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Sprite Pack</span>
                <select id="sprite-pack-selector" class="w-full px-4 py-2.5 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 cursor-pointer">
                    <option value="flowers">Flowers</option>
                    <option value="fireworks">Fireworks</option>
                    <option value="shapes">Shapes</option>
                </select>
            </div>

            <div class="space-y-3">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Background</span>
                <div class="space-y-2">
                    <input class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" id="bg-upload-input" type="file" accept="image/*">
                    <div class="grid grid-cols-2 gap-2">
                        <button class="w-full py-2 bg-blue-100 text-blue-700 text-xs font-semibold rounded hover:bg-blue-200 transition" id="apply-bg-btn">
                            Apply Image
                        </button>
                        <button class="w-full py-2 bg-gray-100 text-gray-500 text-xs font-medium rounded hover:bg-gray-200 transition" id="reset-bg-btn">
                            Reset Gradient
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider block">Custom Words</span>
                <textarea class="w-full p-3 text-sm text-gray-700 bg-gray-50 border border-gray-200 rounded-lg focus:ring-blue-300 focus:border-blue-300 resize-none h-24" id="custom-words" placeholder="e.g. Joy, Peace, Kindness..."></textarea>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Fade Duration (Flowers)</span>
                    </div>
                    <input type="range" id="decay-slider" min="0" max="5" step="1" value="2" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Trail Duration & Speed</span>
                    </div>
                    <input type="range" id="trail-slider" min="1" max="10" step="1" value="5" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1">
                        <span>Short/Fast</span>
                        <span>Long/Slow</span>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Growth Speed</span>
                    </div>
                    <input type="range" id="speed-slider" min="1" max="100" value="50" class="w-full bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 pt-4 border-t border-gray-100">
                <button class="col-span-1 px-4 py-3 bg-orange-50 text-orange-700 text-sm font-semibold rounded-xl hover:bg-orange-100 transition text-center" id="record-btn">Record</button>
                <button class="col-span-1 px-4 py-3 bg-green-50 text-green-700 text-sm font-semibold rounded-xl hover:bg-green-100 transition text-center" id="save-btn">Snapshot</button>
                <button class="col-span-1 px-4 py-3 bg-gray-50 text-gray-700 text-sm font-medium rounded-xl hover:bg-gray-100 transition text-center" id="theme-btn">Theme</button>
                <button class="col-span-1 px-4 py-3 bg-red-50 text-red-700 text-sm font-medium rounded-xl hover:bg-red-100 transition text-center" id="clear-btn">Clear</button>
                
                <button class="col-span-2 mt-2 py-4 bg-amber-50 text-amber-700 font-bold rounded-xl hover:bg-amber-100 transition text-center flex items-center justify-center gap-2 border border-amber-200 shadow-sm" id="secrets-btn">
                    <span class="material-symbols-outlined">key</span> Open Secrets
                </button>

            </div>
        </div>
    </aside>

    <div id="secrets-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div id="secrets-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6 transform scale-out modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="material-symbols-outlined text-amber-500">auto_awesome</span> 
                    Discoveries
                </h3>
                <button id="close-secrets" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div id="secrets-grid-view">
                <p class="text-sm text-gray-500 mb-4">
                    Unlock patterns by experimenting with rhythms (Taps) and flow (Drags). Click a discovery to see its activation code.
                </p>
                <div id="secrets-list" class="grid grid-cols-5 gap-2 max-h-60 overflow-y-auto p-1">
                    </div>
                <div class="text-center text-xs text-gray-400 mt-4">
                    Found: <span id="secrets-count">0</span> / 20
                </div>
            </div>

            <div id="secrets-detail-view" class="hidden flex flex-col">
                <button id="back-to-grid" class="text-xs text-blue-500 mb-2 flex items-center hover:underline self-start">
                    <span class="material-symbols-outlined text-sm mr-1">arrow_back</span> Back
                </button>
                
                <div class="bg-amber-50 rounded-xl p-5 border border-amber-100 text-center space-y-4">
                    <div id="detail-id" class="w-16 h-16 bg-amber-200 rounded-full flex items-center justify-center mx-auto text-amber-800 font-bold text-2xl shadow-inner">?</div>
                    
                    <div>
                        <h4 id="detail-title" class="text-lg font-bold text-amber-900">Secret Unlocked</h4>
                        <p id="detail-type" class="text-xs text-amber-700/70 uppercase tracking-wide font-bold mt-1">RHYTHM</p>
                    </div>

                    <div class="text-left bg-white/60 p-4 rounded-lg text-sm border border-amber-100 shadow-sm">
                        <p class="mb-2"><span class="font-bold text-gray-600 block text-xs uppercase mb-1">Trigger:</span>
                        <span id="detail-trigger" class="font-mono text-lg text-amber-600 tracking-wider bg-amber-50 px-2 py-1 rounded">Tap Tap</span></p>
                        
                        <p><span class="font-bold text-gray-600 block text-xs uppercase mb-1">Visual Effect:</span>
                        <span id="detail-reward" class="italic text-gray-700">Blooming Mandala</span></p>
                    </div>

                    <button id="simulate-btn" class="w-full py-3 bg-gradient-to-r from-amber-400 to-amber-500 text-white rounded-xl font-bold shadow-lg hover:from-amber-500 hover:to-amber-600 active:scale-95 transition flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">play_circle</span> Play Example
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="peer-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div id="peer-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-lg p-6 transform scale-out modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 id="peer-modal-name" class="text-xl font-bold text-gray-800">Peer</h3>
                    <p id="peer-modal-meta" class="text-xs text-gray-500 mt-1">Connected: --</p>
                </div>
                <button id="close-peer-modal" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Connection Details</div>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs text-gray-600 space-y-2">
                        <div><span class="font-semibold text-gray-700">Connected at:</span> <span id="peer-connected-at">--</span></div>
                        <div><span class="font-semibold text-gray-700">Duration:</span> <span id="peer-connected-duration">--</span></div>
                    </div>

                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Last 5 Connections</div>
                    <ul id="peer-connection-history" class="space-y-2 text-xs text-gray-600 max-h-44 overflow-y-auto"></ul>
                </div>

                <div class="space-y-3">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Chat</div>
                    <div id="peer-chat-history" class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-xs text-gray-700 h-48 overflow-y-auto space-y-2"></div>
                    <div class="flex items-center justify-between text-[10px] text-gray-500">
                        <span class="uppercase tracking-wider font-semibold">Translation</span>
                        <select id="peer-chat-translate" class="px-2 py-1 text-[10px] text-gray-700 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300">
                            <option value="en">English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="ja">Japanese</option>
                            <option value="th">Thai</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <input id="peer-chat-input" type="text" class="flex-1 px-3 py-2 text-xs border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300" placeholder="Type a message...">
                        <button id="peer-chat-send" class="px-3 py-2 bg-blue-500 text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="session-log-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center invisible modal">
        <div id="session-log-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-2xl p-6 transform scale-out modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Session Log</h3>
                    <p class="text-xs text-gray-500 mt-1" id="session-log-device-id">Device ID: --</p>
                </div>
                <button id="close-session-log" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Local Device</div>
                    <div class="text-sm font-semibold text-gray-700" id="session-log-device-name">--</div>
                    <div class="flex items-center gap-2 text-[11px] text-gray-500">
                        <span id="session-log-status-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-400"></span>
                        <span id="session-log-status-label">Active</span>
                    </div>
                </div>
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 space-y-2">
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Peers</div>
                    <ul id="session-log-peers" class="space-y-2 text-xs text-gray-600 max-h-32 overflow-y-auto"></ul>
                </div>
            </div>

            <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider">Network & Session Events</div>
                <div class="flex gap-2">
                    <button id="session-log-copy" class="px-3 py-2 bg-blue-50 text-blue-700 text-xs font-semibold rounded-lg hover:bg-blue-100 transition">Copy</button>
                    <button id="session-log-download" class="px-3 py-2 bg-emerald-50 text-emerald-700 text-xs font-semibold rounded-lg hover:bg-emerald-100 transition">Download</button>
                </div>
            </div>
            <pre id="session-log-output" class="bg-gray-900 text-gray-100 text-xs rounded-lg p-4 max-h-80 overflow-y-auto whitespace-pre-wrap"></pre>
        </div>
    </div>

    <script>
        const config = {
            currentThemeIndex: 0,
            defaultWords: [
                "Peace", "Gentle", "Warmth", "Love", "Hope", "Empathy", "Calm", "Grace", "Kindness", "Light", "Joy", "Bliss",
                "Serenity", "Breathe Deep", "Be Here", "Soften", "Let Go", "ü™∑ü™∑ü™∑", "Balance", "Harmony",
                "Inner Peace", "Radiate", "Stillness", "Presence", "Gratitude", "Acceptance", "Flow", "Healing", "Strength",
                "Wisdom", "Patience", "Courage", "‚òï‚òï‚òï", " üò¥üò¥üò¥", "‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á", "Relax...", "Deep Breath", "‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏∂‡∏Å‡πÜ"
            ],
            customWords: [],
            speedMultiplier: 1.0,
            decayValue: 0.005,
            trailDecay: 0.01,
            trailSpeed: 1.0,
            useGradient: true,
            backgroundImage: null,
            backgroundImageData: null,
            currentTrail: '‚ô•',
            lastTrailSwitch: Date.now(),
            currentScale: 'original',
            spritePack: 'flowers'
        };

        let width = window.innerWidth; 
        let height = window.innerHeight;
        const canvas = document.getElementById('gameCanvas'); 
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        const visualEntities = []; 
        const wordEntities = []; 
        const particles = [];
        const presencePulses = [];
        let pendingAudioEvents = [];

        // ... [file continues EXACTLY as in your updated peace.html, with no changes or omissions] ...
